"use strict";

/// <reference path ="../../node_modules/@types/reveal/index.d.ts"/>
(function () {
  var plugin = {
    init: function init() {
      var style = document.createElement('style');
      document.head.appendChild(style);
      Reveal.addEventListener('slidechanged', function (event) {
        addSupportForTimedSections(event);
        addSupportForOneTimeSections(event);
        addSupportForUnhideSections(event);
        addSupportToHideControls(event);
      });
      addSupportForAnchorWithDataLink(style.sheet);
      addSupportForProceedToNextAfterVideoPlayed();
    }
  };
  /**
   * Automatic proceed to next slide  once a video has completed
   */

  function addSupportForProceedToNextAfterVideoPlayed() {
    document.querySelectorAll("video[data-auto-next]").forEach(function (v) {
      v.addEventListener('ended', function (_) {
        return Reveal.next();
      });
    });
  }
  /**
   * allows for
   * `<a data-link-indexh="1">link to slide</a>`
   * @param webyarnsCSS
   */


  function addSupportForAnchorWithDataLink(webyarnsCSS) {
    webyarnsCSS.insertRule("a[data-link-indexh] { cursor: pointer }", 0);
    document.querySelectorAll("a[data-link-indexh]").forEach(function (e) {
      return e.addEventListener("click", function (evt) {
        evt.preventDefault();
        var s = e.getAttribute("data-link-indexh");

        if (s) {
          var idx = parseInt(s, 10);
          Reveal.slide(idx);
        }
      });
    });
  }

  function isIndex(value) {
    return /^\d+$/.test(value);
  }
  /**
   *
   * Syntax
   * <section data-auto-move-to="..." data-auto-move-time-sec="..>
   *
   * Automatically moves to a section after a timeout
   * Possible values for data-auto-move-to:
   *  - 'next' and 'prev'
   *  - a url hash value ('#/some-id')
   *  - id of a section ('some-id')
   *  - an position (one-based) of a section ('12')
   *
   *  data-auto-move-time-sec is optional. Defaults to 1 second
   */


  function addSupportForTimedSections(event) {
    var rx = /random\(([0-9,\s]+)\)/;
    var curAutoMove = event.currentSlide.getAttribute("data-auto-move-to");

    if (curAutoMove) {
      var providedValue = event.currentSlide.getAttribute("data-auto-move-time-sec");
      var timeout = providedValue ? Number.parseFloat(providedValue) * 1000 : 1;
      var match = curAutoMove.match(rx);
      var timer = setTimeout(function () {
        if (curAutoMove === "next") {
          Reveal.next();
        } else if (curAutoMove === "prev") {
          Reveal.prev();
        } else if (curAutoMove.charAt(0) === "#") {
          document.location.hash = curAutoMove;
        } else if (match) {
          var values = match[1].split(",").map(function (e) {
            return e.trim();
          }).map(function (i) {
            return Number.parseInt(i, 10);
          });
          var random = values[Math.floor(Math.random() * values.length)];
          Reveal.slide(random);
        } else {
          if (isIndex(curAutoMove)) {
            var slide = parseInt(curAutoMove, 10) - 1;
            Reveal.slide(slide);
          } else {
            // @ts-ignore
            var i = Webyarns.lookupIndex(curAutoMove);

            if (i === -1) {
              console.error("get not find slide with id", curAutoMove);
            }

            Reveal.slide(i);
          }
        }
      }, timeout);
      Reveal.addEventListener('slidechanged', function () {
        return clearTimeout(timer);
      });
    }
  }
  /**
   * syntax <section one-time>
   *
   * Section is shown only one time
   */


  function addSupportForOneTimeSections(event) {
    var prevSlide = event.previousSlide;
    if (!prevSlide) return;
    var onetime = prevSlide.getAttribute("data-one-time");
    if (onetime) prevSlide.setAttribute("data-hidden-section", "true");
  }
  /**
   * syntax <section data-unhide="toggle | once"->
   *
   * Section is shown only one time
   */


  function addSupportForUnhideSections(event) {
    var unhide = event.currentSlide.getAttribute("data-unhide");
    if (!unhide) return;

    switch (unhide) {
      case "toggle":
        event.currentSlide.toggleAttribute("data-hidden-section");
        break;

      case "":
      case "once":
        event.currentSlide.removeAttribute("data-hidden-section");
        break;

      default:
        console.error("webyarn's @data-unhide unknown value ".concat(unhide, ", must be one of: \"toggle\" | \"once\" | \"\""));
    }
  }
  /**
   * syntax: data-hide-controls
   *
   * hides controls on slide
   * @param event
   */


  function addSupportToHideControls(event) {
    var _event$previousSlide;

    var controls = document.querySelector(".controls");

    if (controls && event.currentSlide.hasAttribute("data-hide-controls")) {
      controls.style.display = 'none';
    } else if (controls && (_event$previousSlide = event.previousSlide) !== null && _event$previousSlide !== void 0 && _event$previousSlide.hasAttribute("data-hide-controls")) {
      controls.style.display = 'block';
    }
  } // @ts-ignore


  Reveal.registerPlugin('WebyarnPlugin', plugin); // Polyfills

  if (!Element.prototype.toggleAttribute) {
    Element.prototype.toggleAttribute = function (name, force) {
      if (force !== void 0) force = !!force;

      if (this.hasAttribute(name)) {
        if (force) return true;
        this.removeAttribute(name);
        return false;
      }

      if (force === false) return false;
      this.setAttribute(name, "");
      return true;
    };
  }
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93ZWJ5YXJuLXBsdWdpbi50cyJdLCJuYW1lcyI6WyJwbHVnaW4iLCJpbml0Iiwic3R5bGUiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJoZWFkIiwiYXBwZW5kQ2hpbGQiLCJSZXZlYWwiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJhZGRTdXBwb3J0Rm9yVGltZWRTZWN0aW9ucyIsImFkZFN1cHBvcnRGb3JPbmVUaW1lU2VjdGlvbnMiLCJhZGRTdXBwb3J0Rm9yVW5oaWRlU2VjdGlvbnMiLCJhZGRTdXBwb3J0VG9IaWRlQ29udHJvbHMiLCJhZGRTdXBwb3J0Rm9yQW5jaG9yV2l0aERhdGFMaW5rIiwic2hlZXQiLCJhZGRTdXBwb3J0Rm9yUHJvY2VlZFRvTmV4dEFmdGVyVmlkZW9QbGF5ZWQiLCJxdWVyeVNlbGVjdG9yQWxsIiwiZm9yRWFjaCIsInYiLCJfIiwibmV4dCIsIndlYnlhcm5zQ1NTIiwiaW5zZXJ0UnVsZSIsImUiLCJldnQiLCJwcmV2ZW50RGVmYXVsdCIsInMiLCJnZXRBdHRyaWJ1dGUiLCJpZHgiLCJwYXJzZUludCIsInNsaWRlIiwiaXNJbmRleCIsInZhbHVlIiwidGVzdCIsInJ4IiwiY3VyQXV0b01vdmUiLCJjdXJyZW50U2xpZGUiLCJwcm92aWRlZFZhbHVlIiwidGltZW91dCIsIk51bWJlciIsInBhcnNlRmxvYXQiLCJtYXRjaCIsInRpbWVyIiwic2V0VGltZW91dCIsInByZXYiLCJjaGFyQXQiLCJsb2NhdGlvbiIsImhhc2giLCJ2YWx1ZXMiLCJzcGxpdCIsIm1hcCIsInRyaW0iLCJpIiwicmFuZG9tIiwiTWF0aCIsImZsb29yIiwibGVuZ3RoIiwiV2VieWFybnMiLCJsb29rdXBJbmRleCIsImNvbnNvbGUiLCJlcnJvciIsImNsZWFyVGltZW91dCIsInByZXZTbGlkZSIsInByZXZpb3VzU2xpZGUiLCJvbmV0aW1lIiwic2V0QXR0cmlidXRlIiwidW5oaWRlIiwidG9nZ2xlQXR0cmlidXRlIiwicmVtb3ZlQXR0cmlidXRlIiwiY29udHJvbHMiLCJxdWVyeVNlbGVjdG9yIiwiaGFzQXR0cmlidXRlIiwiZGlzcGxheSIsInJlZ2lzdGVyUGx1Z2luIiwiRWxlbWVudCIsInByb3RvdHlwZSIsIm5hbWUiLCJmb3JjZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUVBLENBQUMsWUFBWTtBQUVULE1BQU1BLE1BQU0sR0FBRztBQUNYQyxJQUFBQSxJQUFJLEVBQUUsZ0JBQU07QUFDUixVQUFNQyxLQUFLLEdBQUdDLFFBQVEsQ0FBQ0MsYUFBVCxDQUF1QixPQUF2QixDQUFkO0FBQ0FELE1BQUFBLFFBQVEsQ0FBQ0UsSUFBVCxDQUFjQyxXQUFkLENBQTBCSixLQUExQjtBQUNBSyxNQUFBQSxNQUFNLENBQUNDLGdCQUFQLENBQXdCLGNBQXhCLEVBQXdDLFVBQUFDLEtBQUssRUFBSTtBQUM3Q0MsUUFBQUEsMEJBQTBCLENBQUNELEtBQUQsQ0FBMUI7QUFDQUUsUUFBQUEsNEJBQTRCLENBQUNGLEtBQUQsQ0FBNUI7QUFDQUcsUUFBQUEsMkJBQTJCLENBQUNILEtBQUQsQ0FBM0I7QUFDQUksUUFBQUEsd0JBQXdCLENBQUNKLEtBQUQsQ0FBeEI7QUFDSCxPQUxEO0FBTUFLLE1BQUFBLCtCQUErQixDQUFDWixLQUFLLENBQUNhLEtBQVAsQ0FBL0I7QUFDQUMsTUFBQUEsMENBQTBDO0FBRzdDO0FBZFUsR0FBZjtBQWlCQTtBQUNKO0FBQ0E7O0FBRUksV0FBU0EsMENBQVQsR0FBc0Q7QUFDbERiLElBQUFBLFFBQVEsQ0FBQ2MsZ0JBQVQsQ0FBNEMsdUJBQTVDLEVBQXFFQyxPQUFyRSxDQUE2RSxVQUFBQyxDQUFDLEVBQUk7QUFDOUVBLE1BQUFBLENBQUMsQ0FBQ1gsZ0JBQUYsQ0FBbUIsT0FBbkIsRUFBNEIsVUFBQVksQ0FBQztBQUFBLGVBQUliLE1BQU0sQ0FBQ2MsSUFBUCxFQUFKO0FBQUEsT0FBN0I7QUFDSCxLQUZEO0FBR0g7QUFFRDtBQUNKO0FBQ0E7QUFDQTtBQUNBOzs7QUFDSSxXQUFTUCwrQkFBVCxDQUF5Q1EsV0FBekMsRUFB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QUFrQkssSUFBbEIsQ0FBSixFQUE2QjtBQUN6QixZQUFJQyxLQUFKLEVBQVcsT0FBTyxJQUFQO0FBRVgsYUFBS1QsZUFBTCxDQUFxQlEsSUFBckI7QUFDQSxlQUFPLEtBQVA7QUFDSDs7QUFDRCxVQUFJQyxLQUFLLEtBQUssS0FBZCxFQUFxQixPQUFPLEtBQVA7QUFFckIsV0FBS1osWUFBTCxDQUFrQlcsSUFBbEIsRUFBd0IsRUFBeEI7QUFDQSxhQUFPLElBQVA7QUFDSCxLQWJEO0FBY0g7QUFHSixDQW5MRCIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGggPVwiLi4vLi4vbm9kZV9tb2R1bGVzL0B0eXBlcy9yZXZlYWwvaW5kZXguZC50c1wiLz5cblxuKGZ1bmN0aW9uICgpIHtcblxuICAgIGNvbnN0IHBsdWdpbiA9IHtcbiAgICAgICAgaW5pdDogKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpO1xuICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7XG4gICAgICAgICAgICBSZXZlYWwuYWRkRXZlbnRMaXN0ZW5lcignc2xpZGVjaGFuZ2VkJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgIGFkZFN1cHBvcnRGb3JUaW1lZFNlY3Rpb25zKGV2ZW50KVxuICAgICAgICAgICAgICAgIGFkZFN1cHBvcnRGb3JPbmVUaW1lU2VjdGlvbnMoZXZlbnQpXG4gICAgICAgICAgICAgICAgYWRkU3VwcG9ydEZvclVuaGlkZVNlY3Rpb25zKGV2ZW50KVxuICAgICAgICAgICAgICAgIGFkZFN1cHBvcnRUb0hpZGVDb250cm9scyhldmVudClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYWRkU3VwcG9ydEZvckFuY2hvcldpdGhEYXRhTGluayhzdHlsZS5zaGVldCBhcyBDU1NTdHlsZVNoZWV0KTtcbiAgICAgICAgICAgIGFkZFN1cHBvcnRGb3JQcm9jZWVkVG9OZXh0QWZ0ZXJWaWRlb1BsYXllZCgpXG5cblxuICAgICAgICB9XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEF1dG9tYXRpYyBwcm9jZWVkIHRvIG5leHQgc2xpZGUgIG9uY2UgYSB2aWRlbyBoYXMgY29tcGxldGVkXG4gICAgICovXG5cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0Rm9yUHJvY2VlZFRvTmV4dEFmdGVyVmlkZW9QbGF5ZWQoKSB7XG4gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGw8SFRNTFZpZGVvRWxlbWVudD4oXCJ2aWRlb1tkYXRhLWF1dG8tbmV4dF1cIikuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICAgIHYuYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCBfID0+IFJldmVhbC5uZXh0KCkpXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogYWxsb3dzIGZvclxuICAgICAqIGA8YSBkYXRhLWxpbmstaW5kZXhoPVwiMVwiPmxpbmsgdG8gc2xpZGU8L2E+YFxuICAgICAqIEBwYXJhbSB3ZWJ5YXJuc0NTU1xuICAgICAqL1xuICAgIGZ1bmN0aW9uIGFkZFN1cHBvcnRGb3JBbmNob3JXaXRoRGF0YUxpbmsod2VieWFybnNDU1M6IENTU1N0eWxlU2hlZXQpIHtcbiAgICAgICAgd2VieWFybnNDU1MuaW5zZXJ0UnVsZShcImFbZGF0YS1saW5rLWluZGV4aF0geyBjdXJzb3I6IHBvaW50ZXIgfVwiLCAwKTtcbiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChcImFbZGF0YS1saW5rLWluZGV4aF1cIilcbiAgICAgICAgICAgIC5mb3JFYWNoKGUgPT4gZS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKGV2dCkgPT4ge1xuICAgICAgICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHMgPSBlLmdldEF0dHJpYnV0ZShcImRhdGEtbGluay1pbmRleGhcIik7XG4gICAgICAgICAgICAgICAgaWYgKHMpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWR4ID0gcGFyc2VJbnQocywgMTApO1xuICAgICAgICAgICAgICAgICAgICBSZXZlYWwuc2xpZGUoaWR4KVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSkpXG4gICAgfVxuXG5cbiAgICBmdW5jdGlvbiBpc0luZGV4KHZhbHVlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIC9eXFxkKyQvLnRlc3QodmFsdWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogU3ludGF4XG4gICAgICogPHNlY3Rpb24gZGF0YS1hdXRvLW1vdmUtdG89XCIuLi5cIiBkYXRhLWF1dG8tbW92ZS10aW1lLXNlYz1cIi4uPlxuICAgICAqXG4gICAgICogQXV0b21hdGljYWxseSBtb3ZlcyB0byBhIHNlY3Rpb24gYWZ0ZXIgYSB0aW1lb3V0XG4gICAgICogUG9zc2libGUgdmFsdWVzIGZvciBkYXRhLWF1dG8tbW92ZS10bzpcbiAgICAgKiAgLSAnbmV4dCcgYW5kICdwcmV2J1xuICAgICAqICAtIGEgdXJsIGhhc2ggdmFsdWUgKCcjL3NvbWUtaWQnKVxuICAgICAqICAtIGlkIG9mIGEgc2VjdGlvbiAoJ3NvbWUtaWQnKVxuICAgICAqICAtIGFuIHBvc2l0aW9uIChvbmUtYmFzZWQpIG9mIGEgc2VjdGlvbiAoJzEyJylcbiAgICAgKlxuICAgICAqICBkYXRhLWF1dG8tbW92ZS10aW1lLXNlYyBpcyBvcHRpb25hbC4gRGVmYXVsdHMgdG8gMSBzZWNvbmRcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0Rm9yVGltZWRTZWN0aW9ucyhldmVudDogU2xpZGVFdmVudCkge1xuXG4gICAgICAgIGNvbnN0IHJ4ID0gL3JhbmRvbVxcKChbMC05LFxcc10rKVxcKS87XG4gICAgICAgIGNvbnN0IGN1ckF1dG9Nb3ZlID0gZXZlbnQuY3VycmVudFNsaWRlLmdldEF0dHJpYnV0ZShcImRhdGEtYXV0by1tb3ZlLXRvXCIpO1xuICAgICAgICBpZiAoY3VyQXV0b01vdmUpIHtcbiAgICAgICAgICAgIGNvbnN0IHByb3ZpZGVkVmFsdWUgPSBldmVudC5jdXJyZW50U2xpZGUuZ2V0QXR0cmlidXRlKFwiZGF0YS1hdXRvLW1vdmUtdGltZS1zZWNcIik7XG4gICAgICAgICAgICBjb25zdCB0aW1lb3V0ID0gcHJvdmlkZWRWYWx1ZSA/IE51bWJlci5wYXJzZUZsb2F0KHByb3ZpZGVkVmFsdWUpICogMTAwMCA6IDE7XG4gICAgICAgICAgICBjb25zdCBtYXRjaCA9IGN1ckF1dG9Nb3ZlLm1hdGNoKHJ4KVxuICAgICAgICAgICAgY29uc3QgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoY3VyQXV0b01vdmUgPT09IFwibmV4dFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIFJldmVhbC5uZXh0KClcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGN1ckF1dG9Nb3ZlID09PSBcInByZXZcIikge1xuICAgICAgICAgICAgICAgICAgICBSZXZlYWwucHJldigpXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJBdXRvTW92ZS5jaGFyQXQoMCkgPT09IFwiI1wiKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggPSBjdXJBdXRvTW92ZTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IG1hdGNoWzFdLnNwbGl0KFwiLFwiKS5tYXAoZSA9PiBlLnRyaW0oKSkubWFwKGkgPT4gTnVtYmVyLnBhcnNlSW50KGksIDEwKSlcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmFuZG9tID0gdmFsdWVzW01hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHZhbHVlcy5sZW5ndGgpXVxuICAgICAgICAgICAgICAgICAgICBSZXZlYWwuc2xpZGUocmFuZG9tKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNJbmRleChjdXJBdXRvTW92ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNsaWRlID0gcGFyc2VJbnQoY3VyQXV0b01vdmUsIDEwKSAtIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICBSZXZlYWwuc2xpZGUoc2xpZGUpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaSA9IFdlYnlhcm5zLmxvb2t1cEluZGV4KGN1ckF1dG9Nb3ZlKVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihcImdldCBub3QgZmluZCBzbGlkZSB3aXRoIGlkXCIsIGN1ckF1dG9Nb3ZlKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnNsaWRlKGkpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCB0aW1lb3V0KTtcbiAgICAgICAgICAgIFJldmVhbC5hZGRFdmVudExpc3RlbmVyKCdzbGlkZWNoYW5nZWQnLCAoKSA9PiBjbGVhclRpbWVvdXQodGltZXIpKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogc3ludGF4IDxzZWN0aW9uIG9uZS10aW1lPlxuICAgICAqXG4gICAgICogU2VjdGlvbiBpcyBzaG93biBvbmx5IG9uZSB0aW1lXG4gICAgICovXG4gICAgZnVuY3Rpb24gYWRkU3VwcG9ydEZvck9uZVRpbWVTZWN0aW9ucyhldmVudDogU2xpZGVFdmVudCkge1xuICAgICAgICBsZXQgcHJldlNsaWRlID0gZXZlbnQucHJldmlvdXNTbGlkZTtcbiAgICAgICAgaWYgKCFwcmV2U2xpZGUpXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgY29uc3Qgb25ldGltZSA9IHByZXZTbGlkZS5nZXRBdHRyaWJ1dGUoXCJkYXRhLW9uZS10aW1lXCIpO1xuICAgICAgICBpZiAob25ldGltZSlcbiAgICAgICAgICAgIHByZXZTbGlkZS5zZXRBdHRyaWJ1dGUoXCJkYXRhLWhpZGRlbi1zZWN0aW9uXCIsIFwidHJ1ZVwiKVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogc3ludGF4IDxzZWN0aW9uIGRhdGEtdW5oaWRlPVwidG9nZ2xlIHwgb25jZVwiLT5cbiAgICAgKlxuICAgICAqIFNlY3Rpb24gaXMgc2hvd24gb25seSBvbmUgdGltZVxuICAgICAqL1xuICAgIGZ1bmN0aW9uIGFkZFN1cHBvcnRGb3JVbmhpZGVTZWN0aW9ucyhldmVudDogU2xpZGVFdmVudCkge1xuICAgICAgICBjb25zdCB1bmhpZGUgPSBldmVudC5jdXJyZW50U2xpZGUuZ2V0QXR0cmlidXRlKFwiZGF0YS11bmhpZGVcIilcbiAgICAgICAgaWYgKCF1bmhpZGUpXG4gICAgICAgICAgICByZXR1cm5cblxuICAgICAgICBzd2l0Y2ggKHVuaGlkZSkge1xuICAgICAgICAgICAgY2FzZSBcInRvZ2dsZVwiOlxuICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTbGlkZS50b2dnbGVBdHRyaWJ1dGUoXCJkYXRhLWhpZGRlbi1zZWN0aW9uXCIpXG4gICAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGNhc2UgXCJcIjpcbiAgICAgICAgICAgIGNhc2UgXCJvbmNlXCI6XG4gICAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFNsaWRlLnJlbW92ZUF0dHJpYnV0ZShcImRhdGEtaGlkZGVuLXNlY3Rpb25cIilcbiAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGB3ZWJ5YXJuJ3MgQGRhdGEtdW5oaWRlIHVua25vd24gdmFsdWUgJHt1bmhpZGV9LCBtdXN0IGJlIG9uZSBvZjogXCJ0b2dnbGVcIiB8IFwib25jZVwiIHwgXCJcImAsIClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHN5bnRheDogZGF0YS1oaWRlLWNvbnRyb2xzXG4gICAgICpcbiAgICAgKiBoaWRlcyBjb250cm9scyBvbiBzbGlkZVxuICAgICAqIEBwYXJhbSBldmVudFxuICAgICAqL1xuICAgIGZ1bmN0aW9uIGFkZFN1cHBvcnRUb0hpZGVDb250cm9scyhldmVudDogU2xpZGVFdmVudCkge1xuICAgICAgICBjb25zdCBjb250cm9scyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3I8SFRNTEVsZW1lbnQ+KFwiLmNvbnRyb2xzXCIpXG4gICAgICAgIGlmIChjb250cm9scyAmJiBldmVudC5jdXJyZW50U2xpZGUuaGFzQXR0cmlidXRlKFwiZGF0YS1oaWRlLWNvbnRyb2xzXCIpKXtcbiAgICAgICAgICAgIGNvbnRyb2xzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICAgICAgfSBlbHNlIGlmIChjb250cm9scyAmJiBldmVudC5wcmV2aW91c1NsaWRlPy5oYXNBdHRyaWJ1dGUoXCJkYXRhLWhpZGUtY29udHJvbHNcIikpe1xuICAgICAgICAgICAgY29udHJvbHMuc3R5bGUuZGlzcGxheSA9ICdibG9jaydcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBSZXZlYWwucmVnaXN0ZXJQbHVnaW4oJ1dlYnlhcm5QbHVnaW4nLCBwbHVnaW4pO1xuXG4gICAgLy8gUG9seWZpbGxzXG4gICAgaWYgKCFFbGVtZW50LnByb3RvdHlwZS50b2dnbGVBdHRyaWJ1dGUpIHtcbiAgICAgICAgRWxlbWVudC5wcm90b3R5cGUudG9nZ2xlQXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgZm9yY2UpIHtcbiAgICAgICAgICAgIGlmKGZvcmNlICE9PSB2b2lkIDApIGZvcmNlID0gISFmb3JjZVxuXG4gICAgICAgICAgICBpZiAodGhpcy5oYXNBdHRyaWJ1dGUobmFtZSkpIHtcbiAgICAgICAgICAgICAgICBpZiAoZm9yY2UpIHJldHVybiB0cnVlO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGZvcmNlID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShuYW1lLCBcIlwiKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgIH1cblxuXG59KSgpXG4iXX0=