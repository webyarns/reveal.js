"use strict";

/// <reference path ="../../node_modules/@types/reveal/index.d.ts"/>
(function () {
  var plugin = {
    init: function init() {
      var style = document.createElement('style');
      document.head.appendChild(style);
      Reveal.addEventListener('slidechanged', function (event) {
        addSupportForTimedSections(event);
        addSupportForOneTimeSections(event);
        addSupportForUnhideSections(event);
        addSupportToHideControls(event);
        addSupportToHideOtherSections(event);
      });
      addSupportForAnchorWithDataLink(style.sheet);
      addSupportForProceedToNextAfterVideoPlayed();
    }
  };
  /**
   * Automatic proceed to next slide  once a video has completed
   */

  function addSupportForProceedToNextAfterVideoPlayed() {
    document.querySelectorAll("video[data-auto-next]").forEach(function (v) {
      v.addEventListener('ended', function (_) {
        return Reveal.next();
      });
    });
  }
  /**
   * allows for
   * `<a data-link-indexh="1">link to slide</a>`
   * @param webyarnsCSS
   */


  function addSupportForAnchorWithDataLink(webyarnsCSS) {
    webyarnsCSS.insertRule("a[data-link-indexh] { cursor: pointer }", 0);
    document.querySelectorAll("a[data-link-indexh]").forEach(function (e) {
      return e.addEventListener("click", function (evt) {
        evt.preventDefault();
        var s = e.getAttribute("data-link-indexh");

        if (s) {
          var idx = parseInt(s, 10);
          Reveal.slide(idx);
        }
      });
    });
  }

  function isIndex(value) {
    return /^\d+$/.test(value);
  }
  /**
   *
   * Syntax
   * <section data-auto-move-to="..." data-auto-move-time-sec="..>
   *
   * Automatically moves to a section after a timeout
   * Possible values for data-auto-move-to:
   *  - 'next' and 'prev'
   *  - a url hash value ('#/some-id')
   *  - id of a section ('some-id')
   *  - an position (one-based) of a section ('12')
   *
   *  data-auto-move-time-sec is optional. Defaults to 1 second
   */


  function addSupportForTimedSections(event) {
    var rx = /random\(([0-9,\s]+)\)/;
    var curAutoMove = event.currentSlide.getAttribute("data-auto-move-to");

    if (curAutoMove) {
      var providedValue = event.currentSlide.getAttribute("data-auto-move-time-sec");
      var timeout = providedValue ? Number.parseFloat(providedValue) * 1000 : 1;
      var match = curAutoMove.match(rx);
      var timer = setTimeout(function () {
        if (curAutoMove === "next") {
          Reveal.next();
        } else if (curAutoMove === "prev") {
          Reveal.prev();
        } else if (curAutoMove.charAt(0) === "#") {
          document.location.hash = curAutoMove;
        } else if (match) {
          var values = match[1].split(",").map(function (e) {
            return e.trim();
          }).map(function (i) {
            return Number.parseInt(i, 10);
          });
          var random = values[Math.floor(Math.random() * values.length)];
          Reveal.slide(random);
        } else {
          if (isIndex(curAutoMove)) {
            var slide = parseInt(curAutoMove, 10) - 1;
            Reveal.slide(slide);
          } else {
            // @ts-ignore
            var i = Webyarns.lookupIndex(curAutoMove);

            if (i === -1) {
              console.error("get not find slide with id", curAutoMove);
            }

            Reveal.slide(i);
          }
        }
      }, timeout);
      Reveal.addEventListener('slidechanged', function () {
        return clearTimeout(timer);
      });
    }
  }
  /**
   * syntax <section one-time>
   *
   * Section is shown only one time
   */


  function addSupportForOneTimeSections(event) {
    var prevSlide = event.previousSlide;
    if (!prevSlide) return;
    var onetime = prevSlide.getAttribute("data-one-time");
    if (onetime) prevSlide.setAttribute("data-hidden-section", "true");
  }
  /**
   * syntax <section data-unhide="toggle | once"->
   *
   * Section is shown only one time
   */


  function addSupportForUnhideSections(event) {
    var unhide = event.currentSlide.getAttribute("data-unhide");
    if (!unhide) return;

    switch (unhide) {
      case "toggle":
        event.currentSlide.toggleAttribute("data-hidden-section");
        break;

      case "":
      case "once":
        event.currentSlide.removeAttribute("data-hidden-section");
        break;

      default:
        console.error("webyarn's @data-unhide unknown value ".concat(unhide, ", must be one of: \"toggle\" | \"once\" | \"\""));
    }
  }
  /**
   * syntax: data-hide-controls
   *
   * hides controls on slide
   * @param event
   */


  function addSupportToHideControls(event) {
    var _event$previousSlide;

    var controls = document.querySelector(".controls");
    var hideOnPrev = (_event$previousSlide = event.previousSlide) === null || _event$previousSlide === void 0 ? void 0 : _event$previousSlide.hasAttribute("data-hide-controls");
    var hideOnCurrent = event.currentSlide.hasAttribute("data-hide-controls");

    if (controls && hideOnPrev) {
      controls.style.display = 'block';
      controls.querySelectorAll("button:not(.navigate-left)").forEach(function (e) {
        e.style.display = "block";
        e.classList.remove("impair");
        e.disabled = false;
      });
    }

    if (controls && hideOnCurrent) {
      var action = event.currentSlide.getAttribute("data-hide-controls");

      if (!action || action === "") {
        console.log("here");
        controls.style.display = 'none';
      } else {
        var actions = action.split(",").map(function (s) {
          return s.trim();
        });

        if (actions.includes("keep-left")) {
          controls.querySelectorAll("button:not(.navigate-left)").forEach(function (e) {
            return e.style.display = "none";
          });
        }

        if (actions.includes("impair-right")) {
          var rightBtn = controls.querySelector(".navigate-right");
          setTimeout(function () {
            rightBtn.classList.remove("enabled");
            rightBtn.classList.add("impair");
            rightBtn.style.display = "block";
            rightBtn.style.visibility = "visible";
            rightBtn.style.opacity = "1";
            rightBtn.disabled = true;
          }, 0);
        }
      }
    }
  }
  /**
   *  syntax data-hide-section="«id»,«id»"
   * @param event
   */


  function addSupportToHideOtherSections(event) {
    var a = event.currentSlide.getAttribute("data-hide-section");
    if (!a) return;
    a.split(",").forEach(function (id) {
      var section = document.getElementById(id);
      if (!section) console.warn("cannot find element with id ".concat(id, " to hide"));else section.setAttribute("data-hidden-section", "");
    });
  } // @ts-ignore


  Reveal.registerPlugin('WebyarnPlugin', plugin); // Polyfills

  if (!Element.prototype.toggleAttribute) {
    Element.prototype.toggleAttribute = function (name, force) {
      if (force !== void 0) force = !!force;

      if (this.hasAttribute(name)) {
        if (force) return true;
        this.removeAttribute(name);
        return false;
      }

      if (force === false) return false;
      this.setAttribute(name, "");
      return true;
    };
  }
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93ZWJ5YXJuLXBsdWdpbi50cyJdLCJuYW1lcyI6WyJwbHVnaW4iLCJpbml0Iiwic3R5bGUiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJoZWFkIiwiYXBwZW5kQ2hpbGQiLCJSZXZlYWwiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJhZGRTdXBwb3J0Rm9yVGltZWRTZWN0aW9ucyIsImFkZFN1cHBvcnRGb3JPbmVUaW1lU2VjdGlvbnMiLCJhZGRTdXBwb3J0Rm9yVW5oaWRlU2VjdGlvbnMiLCJhZGRTdXBwb3J0VG9IaWRlQ29udHJvbHMiLCJhZGRTdXBwb3J0VG9IaWRlT3RoZXJTZWN0aW9ucyIsImFkZFN1cHBvcnRGb3JBbmNob3JXaXRoRGF0YUxpbmsiLCJzaGVldCIsImFkZFN1cHBvcnRGb3JQcm9jZWVkVG9OZXh0QWZ0ZXJWaWRlb1BsYXllZCIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJmb3JFYWNoIiwidiIsIl8iLCJuZXh0Iiwid2VieWFybnNDU1MiLCJpbnNlcnRSdWxlIiwiZSIsImV2dCIsInByZXZlbnREZWZhdWx0IiwicyIsImdldEF0dHJpYnV0ZSIsImlkeCIsInBhcnNlSW50Iiwic2xpZGUiLCJpc0luZGV4IiwidmFsdWUiLCJ0ZXN0IiwicngiLCJjdXJBdXRvTW92ZSIsImN1cnJlbnRTbGlkZSIsInByb3ZpZGVkVmFsdWUiLCJ0aW1lb3V0IiwiTnVtYmVyIiwicGFyc2VGbG9hdCIsIm1hdGNoIiwidGltZXIiLCJzZXRUaW1lb3V0IiwicHJldiIsImNoYXJBdCIsImxvY2F0aW9uIiwiaGFzaCIsInZhbHVlcyIsInNwbGl0IiwibWFwIiwidHJpbSIsImkiLCJyYW5kb20iLCJNYXRoIiwiZmxvb3IiLCJsZW5ndGgiLCJXZWJ5YXJucyIsImxvb2t1cEluZGV4IiwiY29uc29sZSIsImVycm9yIiwiY2xlYXJUaW1lb3V0IiwicHJldlNsaWRlIiwicHJldmlvdXNTbGlkZSIsIm9uZXRpbWUiLCJzZXRBdHRyaWJ1dGUiLCJ1bmhpZGUiLCJ0b2dnbGVBdHRyaWJ1dGUiLCJyZW1vdmVBdHRyaWJ1dGUiLCJjb250cm9scyIsInF1ZXJ5U2VsZWN0b3IiLCJoaWRlT25QcmV2IiwiaGFzQXR0cmlidXRlIiwiaGlkZU9uQ3VycmVudCIsImRpc3BsYXkiLCJjbGFzc0xpc3QiLCJyZW1vdmUiLCJkaXNhYmxlZCIsImFjdGlvbiIsImxvZyIsImFjdGlvbnMiLCJpbmNsdWRlcyIsInJpZ2h0QnRuIiwiYWRkIiwidmlzaWJpbGl0eSIsIm9wYWNpdHkiLCJhIiwiaWQiLCJzZWN0aW9uIiwiZ2V0RWxlbWVudEJ5SWQiLCJ3YXJuIiwicmVnaXN0ZXJQbHVnaW4iLCJFbGVtZW50IiwicHJvdG90eXBlIiwibmFtZSIsImZvcmNlIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBRUEsQ0FBQyxZQUFZO0FBRVQsTUFBTUEsTUFBTSxHQUFHO0FBQ1hDLElBQUFBLElBQUksRUFBRSxnQkFBTTtBQUNSLFVBQU1DLEtBQUssR0FBR0MsUUFBUSxDQUFDQyxhQUFULENBQXVCLE9BQXZCLENBQWQ7QUFDQUQsTUFBQUEsUUFBUSxDQUFDRSxJQUFULENBQWNDLFdBQWQsQ0FBMEJKLEtBQTFCO0FBQ0FLLE1BQUFBLE1BQU0sQ0FBQ0MsZ0JBQVAsQ0FBd0IsY0FBeEIsRUFBd0MsVUFBQUMsS0FBSyxFQUFJO0FBQzdDQyxRQUFBQSwwQkFBMEIsQ0FBQ0QsS0FBRCxDQUExQjtBQUNBRSxRQUFBQSw0QkFBNEIsQ0FBQ0YsS0FBRCxDQUE1QjtBQUNBRyxRQUFBQSwyQkFBMkIsQ0FBQ0gsS0FBRCxDQUEzQjtBQUNBSSxRQUFBQSx3QkFBd0IsQ0FBQ0osS0FBRCxDQUF4QjtBQUNBSyxRQUFBQSw2QkFBNkIsQ0FBQ0wsS0FBRCxDQUE3QjtBQUNILE9BTkQ7QUFPQU0sTUFBQUEsK0JBQStCLENBQUNiLEtBQUssQ0FBQ2MsS0FBUCxDQUEvQjtBQUNBQyxNQUFBQSwwQ0FBMEM7QUFHN0M7QUFmVSxHQUFmO0FBa0JBO0FBQ0o7QUFDQTs7QUFFSSxXQUFTQSwwQ0FBVCxHQUFzRDtBQUNsRGQsSUFBQUEsUUFBUSxDQUFDZSxnQkFBVCxDQUE0Qyx1QkFBNUMsRUFBcUVDLE9BQXJFLENBQTZFLFVBQUFDLENBQUMsRUFBSTtBQUM5RUEsTUFBQUEsQ0FBQyxDQUFDWixnQkFBRixDQUFtQixPQUFuQixFQUE0QixVQUFBYSxDQUFDO0FBQUEsZUFBSWQsTUFBTSxDQUFDZSxJQUFQLEVBQUo7QUFBQSxPQUE3QjtBQUNILEtBRkQ7QUFHSDtBQUVEO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7OztBQUNJLFdBQVNQLCtCQUFULENBQXlDUSxXQUF6QyxFQUFxRTtBQUNqRUEsSUFBQUEsV0FBVyxDQUFDQyxVQUFaLENBQXVCLHlDQUF2QixFQUFrRSxDQUFsRTtBQUNBckIsSUFBQUEsUUFBUSxDQUFDZSxnQkFBVCxDQUEwQixxQkFBMUIsRUFDS0MsT0FETCxDQUNhLFVBQUFNLENBQUM7QUFBQSxhQUFJQSxDQUFDLENBQUNqQixnQkFBRixDQUFtQixPQUFuQixFQUE0QixVQUFDa0IsR0FBRCxFQUFTO0FBQy9DQSxRQUFBQSxHQUFHLENBQUNDLGNBQUo7QUFDQSxZQUFNQyxDQUFDLEdBQUdILENBQUMsQ0FBQ0ksWUFBRixDQUFlLGtCQUFmLENBQVY7O0FBQ0EsWUFBSUQsQ0FBSixFQUFPO0FBQ0gsY0FBTUUsR0FBRyxHQUFHQyxRQUFRLENBQUNILENBQUQsRUFBSSxFQUFKLENBQXBCO0FBQ0FyQixVQUFBQSxNQUFNLENBQUN5QixLQUFQLENBQWFGLEdBQWI7QUFDSDtBQUVKLE9BUmEsQ0FBSjtBQUFBLEtBRGQ7QUFVSDs7QUFHRCxXQUFTRyxPQUFULENBQWlCQyxLQUFqQixFQUF5QztBQUNyQyxXQUFPLFFBQVFDLElBQVIsQ0FBYUQsS0FBYixDQUFQO0FBQ0g7QUFFRDtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDSSxXQUFTeEIsMEJBQVQsQ0FBb0NELEtBQXBDLEVBQXVEO0FBRW5ELFFBQU0yQixFQUFFLEdBQUcsdUJBQVg7QUFDQSxRQUFNQyxXQUFXLEdBQUc1QixLQUFLLENBQUM2QixZQUFOLENBQW1CVCxZQUFuQixDQUFnQyxtQkFBaEMsQ0FBcEI7O0FBQ0EsUUFBSVEsV0FBSixFQUFpQjtBQUNiLFVBQU1FLGFBQWEsR0FBRzlCLEtBQUssQ0FBQzZCLFlBQU4sQ0FBbUJULFlBQW5CLENBQWdDLHlCQUFoQyxDQUF0QjtBQUNBLFVBQU1XLE9BQU8sR0FBR0QsYUFBYSxHQUFHRSxNQUFNLENBQUNDLFVBQVAsQ0FBa0JILGFBQWxCLElBQW1DLElBQXRDLEdBQTZDLENBQTFFO0FBQ0EsVUFBTUksS0FBSyxHQUFHTixXQUFXLENBQUNNLEtBQVosQ0FBa0JQLEVBQWxCLENBQWQ7QUFDQSxVQUFNUSxLQUFLLEdBQUdDLFVBQVUsQ0FBQyxZQUFZO0FBQ2pDLFlBQUlSLFdBQVcsS0FBSyxNQUFwQixFQUE0QjtBQUN4QjlCLFVBQUFBLE1BQU0sQ0FBQ2UsSUFBUDtBQUNILFNBRkQsTUFFTyxJQUFJZSxXQUFXLEtBQUssTUFBcEIsRUFBNEI7QUFDL0I5QixVQUFBQSxNQUFNLENBQUN1QyxJQUFQO0FBQ0gsU0FGTSxNQUVBLElBQUlULFdBQVcsQ0FBQ1UsTUFBWixDQUFtQixDQUFuQixNQUEwQixHQUE5QixFQUFtQztBQUN0QzVDLFVBQUFBLFFBQVEsQ0FBQzZDLFFBQVQsQ0FBa0JDLElBQWxCLEdBQXlCWixXQUF6QjtBQUNILFNBRk0sTUFFQSxJQUFJTSxLQUFKLEVBQVc7QUFDZCxjQUFNTyxNQUFNLEdBQUdQLEtBQUssQ0FBQyxDQUFELENBQUwsQ0FBU1EsS0FBVCxDQUFlLEdBQWYsRUFBb0JDLEdBQXBCLENBQXdCLFVBQUEzQixDQUFDO0FBQUEsbUJBQUlBLENBQUMsQ0FBQzRCLElBQUYsRUFBSjtBQUFBLFdBQXpCLEVBQXVDRCxHQUF2QyxDQUEyQyxVQUFBRSxDQUFDO0FBQUEsbUJBQUliLE1BQU0sQ0FBQ1YsUUFBUCxDQUFnQnVCLENBQWhCLEVBQW1CLEVBQW5CLENBQUo7QUFBQSxXQUE1QyxDQUFmO0FBQ0EsY0FBTUMsTUFBTSxHQUFHTCxNQUFNLENBQUNNLElBQUksQ0FBQ0MsS0FBTCxDQUFXRCxJQUFJLENBQUNELE1BQUwsS0FBZ0JMLE1BQU0sQ0FBQ1EsTUFBbEMsQ0FBRCxDQUFyQjtBQUNBbkQsVUFBQUEsTUFBTSxDQUFDeUIsS0FBUCxDQUFhdUIsTUFBYjtBQUNILFNBSk0sTUFJQTtBQUNILGNBQUl0QixPQUFPLENBQUNJLFdBQUQsQ0FBWCxFQUEwQjtBQUN0QixnQkFBTUwsS0FBSyxHQUFHRCxRQUFRLENBQUNNLFdBQUQsRUFBYyxFQUFkLENBQVIsR0FBNEIsQ0FBMUM7QUFDQTlCLFlBQUFBLE1BQU0sQ0FBQ3lCLEtBQVAsQ0FBYUEsS0FBYjtBQUNILFdBSEQsTUFHTztBQUNIO0FBQ0EsZ0JBQU1zQixDQUFDLEdBQUdLLFFBQVEsQ0FBQ0MsV0FBVCxDQUFxQnZCLFdBQXJCLENBQVY7O0FBQ0EsZ0JBQUlpQixDQUFDLEtBQUssQ0FBQyxDQUFYLEVBQWM7QUFDVk8sY0FBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWMsNEJBQWQsRUFBNEN6QixXQUE1QztBQUNIOztBQUNEOUIsWUFBQUEsTUFBTSxDQUFDeUIsS0FBUCxDQUFhc0IsQ0FBYjtBQUNIO0FBQ0o7QUFDSixPQXhCdUIsRUF3QnJCZCxPQXhCcUIsQ0FBeEI7QUF5QkFqQyxNQUFBQSxNQUFNLENBQUNDLGdCQUFQLENBQXdCLGNBQXhCLEVBQXdDO0FBQUEsZUFBTXVELFlBQVksQ0FBQ25CLEtBQUQsQ0FBbEI7QUFBQSxPQUF4QztBQUNIO0FBQ0o7QUFFRDtBQUNKO0FBQ0E7QUFDQTtBQUNBOzs7QUFDSSxXQUFTakMsNEJBQVQsQ0FBc0NGLEtBQXRDLEVBQXlEO0FBQ3JELFFBQUl1RCxTQUFTLEdBQUd2RCxLQUFLLENBQUN3RCxhQUF0QjtBQUNBLFFBQUksQ0FBQ0QsU0FBTCxFQUNJO0FBQ0osUUFBTUUsT0FBTyxHQUFHRixTQUFTLENBQUNuQyxZQUFWLENBQXVCLGVBQXZCLENBQWhCO0FBQ0EsUUFBSXFDLE9BQUosRUFDSUYsU0FBUyxDQUFDRyxZQUFWLENBQXVCLHFCQUF2QixFQUE4QyxNQUE5QztBQUVQO0FBRUQ7QUFDSjtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0ksV0FBU3ZELDJCQUFULENBQXFDSCxLQUFyQyxFQUF3RDtBQUNwRCxRQUFNMkQsTUFBTSxHQUFHM0QsS0FBSyxDQUFDNkIsWUFBTixDQUFtQlQsWUFBbkIsQ0FBZ0MsYUFBaEMsQ0FBZjtBQUNBLFFBQUksQ0FBQ3VDLE1BQUwsRUFDSTs7QUFFSixZQUFRQSxNQUFSO0FBQ0ksV0FBSyxRQUFMO0FBQ0kzRCxRQUFBQSxLQUFLLENBQUM2QixZQUFOLENBQW1CK0IsZUFBbkIsQ0FBbUMscUJBQW5DO0FBQ0E7O0FBQ0osV0FBSyxFQUFMO0FBQ0EsV0FBSyxNQUFMO0FBQ0k1RCxRQUFBQSxLQUFLLENBQUM2QixZQUFOLENBQW1CZ0MsZUFBbkIsQ0FBbUMscUJBQW5DO0FBQ0E7O0FBQ0o7QUFDSVQsUUFBQUEsT0FBTyxDQUFDQyxLQUFSLGdEQUFzRE0sTUFBdEQ7QUFUUjtBQVdIO0FBRUQ7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDSSxXQUFTdkQsd0JBQVQsQ0FBa0NKLEtBQWxDLEVBQXFEO0FBQUE7O0FBQ2pELFFBQU04RCxRQUFRLEdBQUdwRSxRQUFRLENBQUNxRSxhQUFULENBQW9DLFdBQXBDLENBQWpCO0FBQ0EsUUFBSUMsVUFBVSwyQkFBR2hFLEtBQUssQ0FBQ3dELGFBQVQseURBQUcscUJBQXFCUyxZQUFyQixDQUFrQyxvQkFBbEMsQ0FBakI7QUFDQSxRQUFJQyxhQUFhLEdBQUdsRSxLQUFLLENBQUM2QixZQUFOLENBQW1Cb0MsWUFBbkIsQ0FBZ0Msb0JBQWhDLENBQXBCOztBQUVBLFFBQUlILFFBQVEsSUFBSUUsVUFBaEIsRUFBNEI7QUFDeEJGLE1BQUFBLFFBQVEsQ0FBQ3JFLEtBQVQsQ0FBZTBFLE9BQWYsR0FBeUIsT0FBekI7QUFDQUwsTUFBQUEsUUFBUSxDQUFDckQsZ0JBQVQsQ0FBNkMsNEJBQTdDLEVBQTJFQyxPQUEzRSxDQUFtRixVQUFBTSxDQUFDLEVBQUk7QUFDcEZBLFFBQUFBLENBQUMsQ0FBQ3ZCLEtBQUYsQ0FBUTBFLE9BQVI7QUFDQW5ELFFBQUFBLENBQUMsQ0FBQ29ELFNBQUYsQ0FBWUMsTUFBWixDQUFtQixRQUFuQjtBQUNBckQsUUFBQUEsQ0FBQyxDQUFDc0QsUUFBRixHQUFhLEtBQWI7QUFDSCxPQUpEO0FBS0g7O0FBQ0QsUUFBSVIsUUFBUSxJQUFJSSxhQUFoQixFQUErQjtBQUMzQixVQUFJSyxNQUFNLEdBQUd2RSxLQUFLLENBQUM2QixZQUFOLENBQW1CVCxZQUFuQixDQUFnQyxvQkFBaEMsQ0FBYjs7QUFDQSxVQUFJLENBQUNtRCxNQUFELElBQVdBLE1BQU0sS0FBSyxFQUExQixFQUE4QjtBQUMxQm5CLFFBQUFBLE9BQU8sQ0FBQ29CLEdBQVIsQ0FBWSxNQUFaO0FBQ0FWLFFBQUFBLFFBQVEsQ0FBQ3JFLEtBQVQsQ0FBZTBFLE9BQWYsR0FBeUIsTUFBekI7QUFFSCxPQUpELE1BSU87QUFFSCxZQUFNTSxPQUFPLEdBQUdGLE1BQU0sQ0FBRTdCLEtBQVIsQ0FBZSxHQUFmLEVBQXFCQyxHQUFyQixDQUF5QixVQUFBeEIsQ0FBQztBQUFBLGlCQUFJQSxDQUFDLENBQUN5QixJQUFGLEVBQUo7QUFBQSxTQUExQixDQUFoQjs7QUFDQSxZQUFJNkIsT0FBTyxDQUFDQyxRQUFSLENBQWlCLFdBQWpCLENBQUosRUFBbUM7QUFDL0JaLFVBQUFBLFFBQVEsQ0FBQ3JELGdCQUFULENBQTZDLDRCQUE3QyxFQUEyRUMsT0FBM0UsQ0FBbUYsVUFBQU0sQ0FBQztBQUFBLG1CQUFJQSxDQUFDLENBQUN2QixLQUFGLENBQVEwRSxPQUFSLFNBQUo7QUFBQSxXQUFwRjtBQUNIOztBQUNELFlBQUlNLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQixjQUFqQixDQUFKLEVBQXNDO0FBQ2xDLGNBQU1DLFFBQVEsR0FBR2IsUUFBUSxDQUFDQyxhQUFULENBQTBDLGlCQUExQyxDQUFqQjtBQUVBM0IsVUFBQUEsVUFBVSxDQUFDLFlBQU07QUFDYnVDLFlBQUFBLFFBQVEsQ0FBQ1AsU0FBVCxDQUFtQkMsTUFBbkIsQ0FBMEIsU0FBMUI7QUFDQU0sWUFBQUEsUUFBUSxDQUFDUCxTQUFULENBQW1CUSxHQUFuQixDQUF1QixRQUF2QjtBQUNBRCxZQUFBQSxRQUFRLENBQUNsRixLQUFULENBQWUwRSxPQUFmO0FBQ0FRLFlBQUFBLFFBQVEsQ0FBQ2xGLEtBQVQsQ0FBZW9GLFVBQWY7QUFDQUYsWUFBQUEsUUFBUSxDQUFDbEYsS0FBVCxDQUFlcUYsT0FBZixHQUF5QixHQUF6QjtBQUNBSCxZQUFBQSxRQUFRLENBQUNMLFFBQVQsR0FBb0IsSUFBcEI7QUFDSCxXQVBTLEVBT1AsQ0FQTyxDQUFWO0FBUUg7QUFDSjtBQUdKO0FBQ0o7QUFFRDtBQUNKO0FBQ0E7QUFDQTs7O0FBQ0ksV0FBU2pFLDZCQUFULENBQXVDTCxLQUF2QyxFQUEwRDtBQUN0RCxRQUFNK0UsQ0FBQyxHQUFHL0UsS0FBSyxDQUFDNkIsWUFBTixDQUFtQlQsWUFBbkIsQ0FBZ0MsbUJBQWhDLENBQVY7QUFDQSxRQUFJLENBQUMyRCxDQUFMLEVBQ0k7QUFFSkEsSUFBQUEsQ0FBQyxDQUFDckMsS0FBRixDQUFRLEdBQVIsRUFBYWhDLE9BQWIsQ0FBcUIsVUFBQXNFLEVBQUUsRUFBSTtBQUN2QixVQUFNQyxPQUFPLEdBQUd2RixRQUFRLENBQUN3RixjQUFULENBQXdCRixFQUF4QixDQUFoQjtBQUNBLFVBQUksQ0FBQ0MsT0FBTCxFQUNJN0IsT0FBTyxDQUFDK0IsSUFBUix1Q0FBNENILEVBQTVDLGVBREosS0FHSUMsT0FBTyxDQUFDdkIsWUFBUixDQUFxQixxQkFBckIsRUFBNEMsRUFBNUM7QUFDUCxLQU5EO0FBUUgsR0FqTlEsQ0FvTlQ7OztBQUNBNUQsRUFBQUEsTUFBTSxDQUFDc0YsY0FBUCxDQUFzQixlQUF0QixFQUF1QzdGLE1BQXZDLEVBck5TLENBdU5UOztBQUNBLE1BQUksQ0FBQzhGLE9BQU8sQ0FBQ0MsU0FBUixDQUFrQjFCLGVBQXZCLEVBQXdDO0FBQ3BDeUIsSUFBQUEsT0FBTyxDQUFDQyxTQUFSLENBQWtCMUIsZUFBbEIsR0FBb0MsVUFBVTJCLElBQVYsRUFBZ0JDLEtBQWhCLEVBQXVCO0FBQ3ZELFVBQUlBLEtBQUssS0FBSyxLQUFLLENBQW5CLEVBQXNCQSxLQUFLLEdBQUcsQ0FBQyxDQUFDQSxLQUFWOztBQUV0QixVQUFJLEtBQUt2QixZQUFMLENBQWtCc0IsSUFBbEIsQ0FBSixFQUE2QjtBQUN6QixZQUFJQyxLQUFKLEVBQVcsT0FBTyxJQUFQO0FBRVgsYUFBSzNCLGVBQUwsQ0FBcUIwQixJQUFyQjtBQUNBLGVBQU8sS0FBUDtBQUNIOztBQUNELFVBQUlDLEtBQUssS0FBSyxLQUFkLEVBQXFCLE9BQU8sS0FBUDtBQUVyQixXQUFLOUIsWUFBTCxDQUFrQjZCLElBQWxCLEVBQXdCLEVBQXhCO0FBQ0EsYUFBTyxJQUFQO0FBQ0gsS0FiRDtBQWNIO0FBR0osQ0ExT0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoID1cIi4uLy4uL25vZGVfbW9kdWxlcy9AdHlwZXMvcmV2ZWFsL2luZGV4LmQudHNcIi8+XG5cbihmdW5jdGlvbiAoKSB7XG5cbiAgICBjb25zdCBwbHVnaW4gPSB7XG4gICAgICAgIGluaXQ6ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcbiAgICAgICAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpO1xuICAgICAgICAgICAgUmV2ZWFsLmFkZEV2ZW50TGlzdGVuZXIoJ3NsaWRlY2hhbmdlZCcsIGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICBhZGRTdXBwb3J0Rm9yVGltZWRTZWN0aW9ucyhldmVudClcbiAgICAgICAgICAgICAgICBhZGRTdXBwb3J0Rm9yT25lVGltZVNlY3Rpb25zKGV2ZW50KVxuICAgICAgICAgICAgICAgIGFkZFN1cHBvcnRGb3JVbmhpZGVTZWN0aW9ucyhldmVudClcbiAgICAgICAgICAgICAgICBhZGRTdXBwb3J0VG9IaWRlQ29udHJvbHMoZXZlbnQpXG4gICAgICAgICAgICAgICAgYWRkU3VwcG9ydFRvSGlkZU90aGVyU2VjdGlvbnMoZXZlbnQpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGFkZFN1cHBvcnRGb3JBbmNob3JXaXRoRGF0YUxpbmsoc3R5bGUuc2hlZXQgYXMgQ1NTU3R5bGVTaGVldCk7XG4gICAgICAgICAgICBhZGRTdXBwb3J0Rm9yUHJvY2VlZFRvTmV4dEFmdGVyVmlkZW9QbGF5ZWQoKVxuXG5cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBBdXRvbWF0aWMgcHJvY2VlZCB0byBuZXh0IHNsaWRlICBvbmNlIGEgdmlkZW8gaGFzIGNvbXBsZXRlZFxuICAgICAqL1xuXG4gICAgZnVuY3Rpb24gYWRkU3VwcG9ydEZvclByb2NlZWRUb05leHRBZnRlclZpZGVvUGxheWVkKCkge1xuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsPEhUTUxWaWRlb0VsZW1lbnQ+KFwidmlkZW9bZGF0YS1hdXRvLW5leHRdXCIpLmZvckVhY2godiA9PiB7XG4gICAgICAgICAgICB2LmFkZEV2ZW50TGlzdGVuZXIoJ2VuZGVkJywgXyA9PiBSZXZlYWwubmV4dCgpKVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGFsbG93cyBmb3JcbiAgICAgKiBgPGEgZGF0YS1saW5rLWluZGV4aD1cIjFcIj5saW5rIHRvIHNsaWRlPC9hPmBcbiAgICAgKiBAcGFyYW0gd2VieWFybnNDU1NcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0Rm9yQW5jaG9yV2l0aERhdGFMaW5rKHdlYnlhcm5zQ1NTOiBDU1NTdHlsZVNoZWV0KSB7XG4gICAgICAgIHdlYnlhcm5zQ1NTLmluc2VydFJ1bGUoXCJhW2RhdGEtbGluay1pbmRleGhdIHsgY3Vyc29yOiBwb2ludGVyIH1cIiwgMCk7XG4gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJhW2RhdGEtbGluay1pbmRleGhdXCIpXG4gICAgICAgICAgICAuZm9yRWFjaChlID0+IGUuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIChldnQpID0+IHtcbiAgICAgICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBzID0gZS5nZXRBdHRyaWJ1dGUoXCJkYXRhLWxpbmstaW5kZXhoXCIpO1xuICAgICAgICAgICAgICAgIGlmIChzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHBhcnNlSW50KHMsIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnNsaWRlKGlkeClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pKVxuICAgIH1cblxuXG4gICAgZnVuY3Rpb24gaXNJbmRleCh2YWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAvXlxcZCskLy50ZXN0KHZhbHVlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIFN5bnRheFxuICAgICAqIDxzZWN0aW9uIGRhdGEtYXV0by1tb3ZlLXRvPVwiLi4uXCIgZGF0YS1hdXRvLW1vdmUtdGltZS1zZWM9XCIuLj5cbiAgICAgKlxuICAgICAqIEF1dG9tYXRpY2FsbHkgbW92ZXMgdG8gYSBzZWN0aW9uIGFmdGVyIGEgdGltZW91dFxuICAgICAqIFBvc3NpYmxlIHZhbHVlcyBmb3IgZGF0YS1hdXRvLW1vdmUtdG86XG4gICAgICogIC0gJ25leHQnIGFuZCAncHJldidcbiAgICAgKiAgLSBhIHVybCBoYXNoIHZhbHVlICgnIy9zb21lLWlkJylcbiAgICAgKiAgLSBpZCBvZiBhIHNlY3Rpb24gKCdzb21lLWlkJylcbiAgICAgKiAgLSBhbiBwb3NpdGlvbiAob25lLWJhc2VkKSBvZiBhIHNlY3Rpb24gKCcxMicpXG4gICAgICpcbiAgICAgKiAgZGF0YS1hdXRvLW1vdmUtdGltZS1zZWMgaXMgb3B0aW9uYWwuIERlZmF1bHRzIHRvIDEgc2Vjb25kXG4gICAgICovXG4gICAgZnVuY3Rpb24gYWRkU3VwcG9ydEZvclRpbWVkU2VjdGlvbnMoZXZlbnQ6IFNsaWRlRXZlbnQpIHtcblxuICAgICAgICBjb25zdCByeCA9IC9yYW5kb21cXCgoWzAtOSxcXHNdKylcXCkvO1xuICAgICAgICBjb25zdCBjdXJBdXRvTW92ZSA9IGV2ZW50LmN1cnJlbnRTbGlkZS5nZXRBdHRyaWJ1dGUoXCJkYXRhLWF1dG8tbW92ZS10b1wiKTtcbiAgICAgICAgaWYgKGN1ckF1dG9Nb3ZlKSB7XG4gICAgICAgICAgICBjb25zdCBwcm92aWRlZFZhbHVlID0gZXZlbnQuY3VycmVudFNsaWRlLmdldEF0dHJpYnV0ZShcImRhdGEtYXV0by1tb3ZlLXRpbWUtc2VjXCIpO1xuICAgICAgICAgICAgY29uc3QgdGltZW91dCA9IHByb3ZpZGVkVmFsdWUgPyBOdW1iZXIucGFyc2VGbG9hdChwcm92aWRlZFZhbHVlKSAqIDEwMDAgOiAxO1xuICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBjdXJBdXRvTW92ZS5tYXRjaChyeClcbiAgICAgICAgICAgIGNvbnN0IHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGN1ckF1dG9Nb3ZlID09PSBcIm5leHRcIikge1xuICAgICAgICAgICAgICAgICAgICBSZXZlYWwubmV4dCgpXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJBdXRvTW92ZSA9PT0gXCJwcmV2XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnByZXYoKVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VyQXV0b01vdmUuY2hhckF0KDApID09PSBcIiNcIikge1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gY3VyQXV0b01vdmU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZXMgPSBtYXRjaFsxXS5zcGxpdChcIixcIikubWFwKGUgPT4gZS50cmltKCkpLm1hcChpID0+IE51bWJlci5wYXJzZUludChpLCAxMCkpXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmRvbSA9IHZhbHVlc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB2YWx1ZXMubGVuZ3RoKV1cbiAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnNsaWRlKHJhbmRvbSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5kZXgoY3VyQXV0b01vdmUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzbGlkZSA9IHBhcnNlSW50KGN1ckF1dG9Nb3ZlLCAxMCkgLSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnNsaWRlKHNsaWRlKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGkgPSBXZWJ5YXJucy5sb29rdXBJbmRleChjdXJBdXRvTW92ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJnZXQgbm90IGZpbmQgc2xpZGUgd2l0aCBpZFwiLCBjdXJBdXRvTW92ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIFJldmVhbC5zbGlkZShpKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgdGltZW91dCk7XG4gICAgICAgICAgICBSZXZlYWwuYWRkRXZlbnRMaXN0ZW5lcignc2xpZGVjaGFuZ2VkJywgKCkgPT4gY2xlYXJUaW1lb3V0KHRpbWVyKSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHN5bnRheCA8c2VjdGlvbiBvbmUtdGltZT5cbiAgICAgKlxuICAgICAqIFNlY3Rpb24gaXMgc2hvd24gb25seSBvbmUgdGltZVxuICAgICAqL1xuICAgIGZ1bmN0aW9uIGFkZFN1cHBvcnRGb3JPbmVUaW1lU2VjdGlvbnMoZXZlbnQ6IFNsaWRlRXZlbnQpIHtcbiAgICAgICAgbGV0IHByZXZTbGlkZSA9IGV2ZW50LnByZXZpb3VzU2xpZGU7XG4gICAgICAgIGlmICghcHJldlNsaWRlKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIGNvbnN0IG9uZXRpbWUgPSBwcmV2U2xpZGUuZ2V0QXR0cmlidXRlKFwiZGF0YS1vbmUtdGltZVwiKTtcbiAgICAgICAgaWYgKG9uZXRpbWUpXG4gICAgICAgICAgICBwcmV2U2xpZGUuc2V0QXR0cmlidXRlKFwiZGF0YS1oaWRkZW4tc2VjdGlvblwiLCBcInRydWVcIilcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHN5bnRheCA8c2VjdGlvbiBkYXRhLXVuaGlkZT1cInRvZ2dsZSB8IG9uY2VcIi0+XG4gICAgICpcbiAgICAgKiBTZWN0aW9uIGlzIHNob3duIG9ubHkgb25lIHRpbWVcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0Rm9yVW5oaWRlU2VjdGlvbnMoZXZlbnQ6IFNsaWRlRXZlbnQpIHtcbiAgICAgICAgY29uc3QgdW5oaWRlID0gZXZlbnQuY3VycmVudFNsaWRlLmdldEF0dHJpYnV0ZShcImRhdGEtdW5oaWRlXCIpXG4gICAgICAgIGlmICghdW5oaWRlKVxuICAgICAgICAgICAgcmV0dXJuXG5cbiAgICAgICAgc3dpdGNoICh1bmhpZGUpIHtcbiAgICAgICAgICAgIGNhc2UgXCJ0b2dnbGVcIjpcbiAgICAgICAgICAgICAgICBldmVudC5jdXJyZW50U2xpZGUudG9nZ2xlQXR0cmlidXRlKFwiZGF0YS1oaWRkZW4tc2VjdGlvblwiKVxuICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBjYXNlIFwiXCI6XG4gICAgICAgICAgICBjYXNlIFwib25jZVwiOlxuICAgICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTbGlkZS5yZW1vdmVBdHRyaWJ1dGUoXCJkYXRhLWhpZGRlbi1zZWN0aW9uXCIpXG4gICAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgd2VieWFybidzIEBkYXRhLXVuaGlkZSB1bmtub3duIHZhbHVlICR7dW5oaWRlfSwgbXVzdCBiZSBvbmUgb2Y6IFwidG9nZ2xlXCIgfCBcIm9uY2VcIiB8IFwiXCJgLClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHN5bnRheDogZGF0YS1oaWRlLWNvbnRyb2xzXG4gICAgICpcbiAgICAgKiBoaWRlcyBjb250cm9scyBvbiBzbGlkZVxuICAgICAqIEBwYXJhbSBldmVudFxuICAgICAqL1xuICAgIGZ1bmN0aW9uIGFkZFN1cHBvcnRUb0hpZGVDb250cm9scyhldmVudDogU2xpZGVFdmVudCkge1xuICAgICAgICBjb25zdCBjb250cm9scyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3I8SFRNTEVsZW1lbnQ+KFwiLmNvbnRyb2xzXCIpXG4gICAgICAgIGxldCBoaWRlT25QcmV2ID0gZXZlbnQucHJldmlvdXNTbGlkZT8uaGFzQXR0cmlidXRlKFwiZGF0YS1oaWRlLWNvbnRyb2xzXCIpO1xuICAgICAgICBsZXQgaGlkZU9uQ3VycmVudCA9IGV2ZW50LmN1cnJlbnRTbGlkZS5oYXNBdHRyaWJ1dGUoXCJkYXRhLWhpZGUtY29udHJvbHNcIik7XG5cbiAgICAgICAgaWYgKGNvbnRyb2xzICYmIGhpZGVPblByZXYpIHtcbiAgICAgICAgICAgIGNvbnRyb2xzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICAgICAgY29udHJvbHMucXVlcnlTZWxlY3RvckFsbDxIVE1MQnV0dG9uRWxlbWVudD4oXCJidXR0b246bm90KC5uYXZpZ2F0ZS1sZWZ0KVwiKS5mb3JFYWNoKGUgPT4ge1xuICAgICAgICAgICAgICAgIGUuc3R5bGUuZGlzcGxheSA9IGBibG9ja2BcbiAgICAgICAgICAgICAgICBlLmNsYXNzTGlzdC5yZW1vdmUoXCJpbXBhaXJcIilcbiAgICAgICAgICAgICAgICBlLmRpc2FibGVkID0gZmFsc2VcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbnRyb2xzICYmIGhpZGVPbkN1cnJlbnQpIHtcbiAgICAgICAgICAgIGxldCBhY3Rpb24gPSBldmVudC5jdXJyZW50U2xpZGUuZ2V0QXR0cmlidXRlKFwiZGF0YS1oaWRlLWNvbnRyb2xzXCIpO1xuICAgICAgICAgICAgaWYgKCFhY3Rpb24gfHwgYWN0aW9uID09PSBcIlwiKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJoZXJlXCIpO1xuICAgICAgICAgICAgICAgIGNvbnRyb2xzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbnMgPSBhY3Rpb24hLnNwbGl0KChcIixcIikpLm1hcChzID0+IHMudHJpbSgpKVxuICAgICAgICAgICAgICAgIGlmIChhY3Rpb25zLmluY2x1ZGVzKFwia2VlcC1sZWZ0XCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzLnF1ZXJ5U2VsZWN0b3JBbGw8SFRNTEJ1dHRvbkVsZW1lbnQ+KFwiYnV0dG9uOm5vdCgubmF2aWdhdGUtbGVmdClcIikuZm9yRWFjaChlID0+IGUuc3R5bGUuZGlzcGxheSA9IGBub25lYClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbnMuaW5jbHVkZXMoXCJpbXBhaXItcmlnaHRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmlnaHRCdG4gPSBjb250cm9scy5xdWVyeVNlbGVjdG9yPEhUTUxCdXR0b25FbGVtZW50PihcIi5uYXZpZ2F0ZS1yaWdodFwiKSFcblxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0QnRuLmNsYXNzTGlzdC5yZW1vdmUoXCJlbmFibGVkXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEJ0bi5jbGFzc0xpc3QuYWRkKFwiaW1wYWlyXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEJ0bi5zdHlsZS5kaXNwbGF5ID0gYGJsb2NrYFxuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRCdG4uc3R5bGUudmlzaWJpbGl0eSA9IGB2aXNpYmxlYFxuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRCdG4uc3R5bGUub3BhY2l0eSA9IFwiMVwiXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEJ0bi5kaXNhYmxlZCA9IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSwgMClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogIHN5bnRheCBkYXRhLWhpZGUtc2VjdGlvbj1cIsKraWTCuyzCq2lkwrtcIlxuICAgICAqIEBwYXJhbSBldmVudFxuICAgICAqL1xuICAgIGZ1bmN0aW9uIGFkZFN1cHBvcnRUb0hpZGVPdGhlclNlY3Rpb25zKGV2ZW50OiBTbGlkZUV2ZW50KSB7XG4gICAgICAgIGNvbnN0IGEgPSBldmVudC5jdXJyZW50U2xpZGUuZ2V0QXR0cmlidXRlKFwiZGF0YS1oaWRlLXNlY3Rpb25cIik7XG4gICAgICAgIGlmICghYSlcbiAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgIGEuc3BsaXQoXCIsXCIpLmZvckVhY2goaWQgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2VjdGlvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcbiAgICAgICAgICAgIGlmICghc2VjdGlvbilcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYGNhbm5vdCBmaW5kIGVsZW1lbnQgd2l0aCBpZCAke2lkfSB0byBoaWRlYClcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBzZWN0aW9uLnNldEF0dHJpYnV0ZShcImRhdGEtaGlkZGVuLXNlY3Rpb25cIiwgXCJcIilcbiAgICAgICAgfSlcblxuICAgIH1cblxuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIFJldmVhbC5yZWdpc3RlclBsdWdpbignV2VieWFyblBsdWdpbicsIHBsdWdpbik7XG5cbiAgICAvLyBQb2x5ZmlsbHNcbiAgICBpZiAoIUVsZW1lbnQucHJvdG90eXBlLnRvZ2dsZUF0dHJpYnV0ZSkge1xuICAgICAgICBFbGVtZW50LnByb3RvdHlwZS50b2dnbGVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobmFtZSwgZm9yY2UpIHtcbiAgICAgICAgICAgIGlmIChmb3JjZSAhPT0gdm9pZCAwKSBmb3JjZSA9ICEhZm9yY2VcblxuICAgICAgICAgICAgaWYgKHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZvcmNlKSByZXR1cm4gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChmb3JjZSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTtcblxuICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUobmFtZSwgXCJcIik7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICB9XG5cblxufSlcbigpXG4iXX0=