"use strict";

/// <reference path ="../../node_modules/@types/reveal/index.d.ts"/>
(function () {
  var plugin = {
    init: function init() {
      var style = document.createElement('style');
      document.head.appendChild(style);
      Reveal.addEventListener('slidechanged', function (event) {
        addSupportForTimedSections(event);
        addSupportForOneTimeSections(event);
        addSupportForUnhideSections(event);
        addSupportToHideControls(event);
        addSupportToHideOtherSections(event);
        addSupportToUnHideOtherSections(event);
        addSupportToHideAfterVisit(event);
      });
      addSupportToLockOrUnlockAfterVisits();
      addSupportForAnchorWithDataLink(style.sheet);
      addSupportForProceedToNextAfterVideoPlayed();
    }
  };
  /**
   * Automatic proceed to next slide  once a video has completed
   */

  function addSupportForProceedToNextAfterVideoPlayed() {
    document.querySelectorAll("video[data-auto-next]").forEach(function (v) {
      v.addEventListener('ended', function (_) {
        return Reveal.next();
      });
    });
  }
  /**
   * allows for
   * `<a data-link-indexh="1">link to slide</a>`
   * @param webyarnsCSS
   */


  function addSupportForAnchorWithDataLink(webyarnsCSS) {
    webyarnsCSS.insertRule("a[data-link-indexh] { cursor: pointer }", 0);
    document.querySelectorAll("a[data-link-indexh]").forEach(function (e) {
      return e.addEventListener("click", function (evt) {
        evt.preventDefault();
        var s = e.getAttribute("data-link-indexh");

        if (s) {
          var idx = parseInt(s, 10);
          Reveal.slide(idx);
        }
      });
    });
  }

  function isIndex(value) {
    return /^\d+$/.test(value);
  }
  /**
   *
   * Syntax
   * <section data-auto-move-to="..." data-auto-move-time-sec="..>
   *
   * Automatically moves to a section after a timeout
   * Possible values for data-auto-move-to:
   *  - 'next' and 'prev'
   *  - a url hash value ('#/some-id')
   *  - id of a section ('some-id')
   *  - an position (one-based) of a section ('12')
   *
   *  data-auto-move-time-sec is optional. Defaults to 1 second
   */


  function addSupportForTimedSections(event) {
    var rx = /random\(([0-9,\s]+)\)/;
    var curAutoMove = event.currentSlide.getAttribute("data-auto-move-to");

    if (curAutoMove) {
      var providedValue = event.currentSlide.getAttribute("data-auto-move-time-sec");
      var timeout = providedValue ? Number.parseFloat(providedValue) * 1000 : 1;
      var match = curAutoMove.match(rx);
      var timer = setTimeout(function () {
        if (curAutoMove === "next") {
          Reveal.next();
        } else if (curAutoMove === "prev") {
          Reveal.prev();
        } else if (curAutoMove.charAt(0) === "#") {
          document.location.hash = curAutoMove;
        } else if (match) {
          var values = match[1].split(",").map(function (e) {
            return e.trim();
          }).map(function (i) {
            return Number.parseInt(i, 10);
          });
          var random = values[Math.floor(Math.random() * values.length)];
          Reveal.slide(random);
        } else {
          if (isIndex(curAutoMove)) {
            var slide = parseInt(curAutoMove, 10) - 1;
            Reveal.slide(slide);
          } else {
            // @ts-ignore
            var i = Webyarns.lookupIndex(curAutoMove);

            if (i === -1) {
              console.error("get not find slide with id", curAutoMove);
            }

            Reveal.slide(i);
          }
        }
      }, timeout);
      Reveal.addEventListener('slidechanged', function () {
        return clearTimeout(timer);
      });
    }
  }
  /**
   * syntax data-one-time
   *
   * Section is shown only one time
   */


  function addSupportForOneTimeSections(event) {
    var prevSlide = event.previousSlide;
    if (!prevSlide) return;
    var onetime = prevSlide.getAttribute("data-one-time");
    if (onetime) prevSlide.setAttribute("data-hidden-section", "true");
  }
  /**
   * syntax <section data-unhide="toggle | once"->
   *
   * Section is shown only one time
   */


  function addSupportForUnhideSections(event) {
    var unhide = event.currentSlide.getAttribute("data-unhide");
    if (!unhide) return;

    switch (unhide) {
      case "toggle":
        event.currentSlide.toggleAttribute("data-hidden-section");
        break;

      case "":
      case "once":
        event.currentSlide.removeAttribute("data-hidden-section");
        break;

      default:
        console.error("webyarn's @data-unhide unknown value ".concat(unhide, ", must be one of: \"toggle\" | \"once\" | \"\""));
    }
  }
  /**
   * syntax: data-hide-controls
   *
   * hides controls on slide
   * @param event
   */


  function addSupportToHideControls(event) {
    var _event$previousSlide;

    var controls = document.querySelector(".controls");
    var hideOnPrev = (_event$previousSlide = event.previousSlide) === null || _event$previousSlide === void 0 ? void 0 : _event$previousSlide.hasAttribute("data-hide-controls");
    var hideOnCurrent = event.currentSlide.hasAttribute("data-hide-controls");

    if (controls && hideOnPrev) {
      controls.style.display = 'block';
      controls.querySelectorAll("button:not(.navigate-left)").forEach(function (e) {
        e.style.display = "block";
        e.classList.remove("impair");
        e.disabled = false;
      });
    }

    if (controls && hideOnCurrent) {
      var action = event.currentSlide.getAttribute("data-hide-controls");

      if (!action || action === "") {
        controls.style.display = 'none';
      } else {
        var actions = action.split(",").map(function (s) {
          return s.trim();
        });

        if (actions.includes("keep-left")) {
          controls.querySelectorAll("button:not(.navigate-left)").forEach(function (e) {
            return e.style.display = "none";
          });
        }

        if (actions.includes("impair-right")) {
          var rightBtn = controls.querySelector(".navigate-right");
          setTimeout(function () {
            rightBtn.classList.remove("enabled");
            rightBtn.classList.add("impair");
            rightBtn.style.display = "block";
            rightBtn.style.visibility = "visible";
            rightBtn.style.opacity = "1";
            rightBtn.disabled = true;
          }, 0);
        }
      }
    }
  }
  /**
   *  syntax data-hide-section="«id»,«id»"
   * @param event
   */


  function addSupportToHideOtherSections(event) {
    var a = event.currentSlide.getAttribute("data-hide-section");
    if (!a) return;
    a.split(",").forEach(function (id) {
      var section = document.getElementById(id);
      if (!section) console.warn("cannot find element with id ".concat(id, " to hide"));else section.setAttribute("data-hidden-section", "");
    });
  }
  /**
   *  syntax data-unhide-section="«id»,«id»"
   * @param event
   */


  function addSupportToUnHideOtherSections(event) {
    var a = event.currentSlide.getAttribute("data-unhide-section");
    if (!a) return;
    a.split(",").forEach(function (id) {
      var section = document.getElementById(id);
      if (!section) console.warn("cannot find element with id ".concat(id, " to hide"));else section.removeAttribute("data-hidden-section");
    });
  }
  /**
   * data-hide-after-visit
   */


  function addSupportToHideAfterVisit(event) {
    if (event.currentSlide.hasAttribute("data-hide-after-visit")) {
      event.currentSlide.setAttribute("data-hidden-section", "");
    }
  }

  var Action;
  /**
   * data-unlock-after-visited="a,b"
   */

  (function (Action) {
    Action[Action["LOCK"] = 0] = "LOCK";
    Action[Action["UNLOCK"] = 1] = "UNLOCK";
  })(Action || (Action = {}));

  var unlockAttributeName = "data-unlock-after-visited";
  var lockAttributeName = "data-lock-after-visited";

  function addSupportToLockOrUnlockAfterVisits() {
    var unlockData = new Map();
    var lockData = new Map();

    _initLockOrUnlockAfterVisits(unlockAttributeName, unlockData, true);

    _initLockOrUnlockAfterVisits(lockAttributeName, lockData, false);

    Reveal.addEventListener('slidechanged', function (event) {
      var id = event.currentSlide.getAttribute("id");

      if (id) {
        _checkSections(id, unlockAttributeName, unlockData, Action.UNLOCK);

        _checkSections(id, lockAttributeName, lockData, Action.LOCK);
      }
    });
  }

  function _checkSections(id, attributeName, data, action) {
    if (data.has(id)) {
      data.get(id).forEach(function (sectionToLockOrUnlockId) {
        try {
          var sectionToLockOrUnLock = document.getElementById(sectionToLockOrUnlockId);
          var sectionsToVisitRemaining = sectionToLockOrUnLock.getAttribute(attributeName).split("&").map(function (s) {
            return s.trim();
          }).filter(function (s) {
            return s != id;
          });

          if (sectionsToVisitRemaining.length === 0) {
            sectionToLockOrUnLock.removeAttribute(attributeName);
            if (action == Action.UNLOCK) sectionToLockOrUnLock.removeAttribute("data-hidden-section");else sectionToLockOrUnLock.setAttribute("data-hidden-section", "");
          } else sectionToLockOrUnLock.setAttribute(attributeName, sectionsToVisitRemaining.join("&"));
        } catch (e) {
          throw Error("error processing ".concat(sectionToLockOrUnlockId, ": ").concat(e));
        }
      });
      data["delete"](id);
    }
  }

  function _initLockOrUnlockAfterVisits(attributeName, data, hide) {
    document.querySelectorAll("section[".concat(attributeName, "]")).forEach(function (e) {
      var unlockSections = e.getAttribute(attributeName).split("&").map(function (s) {
        return s.trim();
      });
      unlockSections.forEach(function (id) {
        var sectionToUnlockId = e.getAttribute("id");
        if (!sectionToUnlockId) console.error("section with [".concat(attributeName, "] requires an id"));else {
          var _data$get;

          var set = (_data$get = data.get(id)) !== null && _data$get !== void 0 ? _data$get : new Set();
          set.add(sectionToUnlockId);
          data.set(id, set);
        }
      });
      if (hide) e.setAttribute("data-hidden-section", "");
    });
  } // @ts-ignore


  Reveal.registerPlugin('WebyarnPlugin', plugin); // Polyfills

  if (!Element.prototype.toggleAttribute) {
    Element.prototype.toggleAttribute = function (name, force) {
      if (force !== void 0) force = !!force;

      if (this.hasAttribute(name)) {
        if (force) return true;
        this.removeAttribute(name);
        return false;
      }

      if (force === false) return false;
      this.setAttribute(name, "");
      return true;
    };
  }
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93ZWJ5YXJuLXBsdWdpbi50cyJdLCJuYW1lcyI6WyJwbHVnaW4iLCJpbml0Iiwic3R5bGUiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJoZWFkIiwiYXBwZW5kQ2hpbGQiLCJSZXZlYWwiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJhZGRTdXBwb3J0Rm9yVGltZWRTZWN0aW9ucyIsImFkZFN1cHBvcnRGb3JPbmVUaW1lU2VjdGlvbnMiLCJhZGRTdXBwb3J0Rm9yVW5oaWRlU2VjdGlvbnMiLCJhZGRTdXBwb3J0VG9IaWRlQ29udHJvbHMiLCJhZGRTdXBwb3J0VG9IaWRlT3RoZXJTZWN0aW9ucyIsImFkZFN1cHBvcnRUb1VuSGlkZU90aGVyU2VjdGlvbnMiLCJhZGRTdXBwb3J0VG9IaWRlQWZ0ZXJWaXNpdCIsImFkZFN1cHBvcnRUb0xvY2tPclVubG9ja0FmdGVyVmlzaXRzIiwiYWRkU3VwcG9ydEZvckFuY2hvcldpdGhEYXRhTGluayIsInNoZWV0IiwiYWRkU3VwcG9ydEZvclByb2NlZWRUb05leHRBZnRlclZpZGVvUGxheWVkIiwicXVlcnlTZWxlY3RvckFsbCIsImZvckVhY2giLCJ2IiwiXyIsIm5leHQiLCJ3ZWJ5YXJuc0NTUyIsImluc2VydFJ1bGUiLCJlIiwiZXZ0IiwicHJldmVudERlZmF1bHQiLCJzIiwiZ2V0QXR0cmlidXRlIiwiaWR4IiwicGFyc2VJbnQiLCJzbGlkZSIsImlzSW5kZXgiLCJ2YWx1ZSIsInRlc3QiLCJyeCIsImN1ckF1dG9Nb3ZlIiwiY3VycmVudFNsaWRlIiwicHJvdmlkZWRWYWx1ZSIsInRpbWVvdXQiLCJOdW1iZXIiLCJwYXJzZUZsb2F0IiwibWF0Y2giLCJ0aW1lciIsInNldFRpbWVvdXQiLCJwcmV2IiwiY2hhckF0IiwibG9jYXRpb24iLCJoYXNoIiwidmFsdWVzIiwic3BsaXQiLCJtYXAiLCJ0cmltIiwiaSIsInJhbmRvbSIsIk1hdGgiLCJmbG9vciIsImxlbmd0aCIsIldlYnlhcm5zIiwibG9va3VwSW5kZXgiLCJjb25zb2xlIiwiZXJyb3IiLCJjbGVhclRpbWVvdXQiLCJwcmV2U2xpZGUiLCJwcmV2aW91c1NsaWRlIiwib25ldGltZSIsInNldEF0dHJpYnV0ZSIsInVuaGlkZSIsInRvZ2dsZUF0dHJpYnV0ZSIsInJlbW92ZUF0dHJpYnV0ZSIsImNvbnRyb2xzIiwicXVlcnlTZWxlY3RvciIsImhpZGVPblByZXYiLCJoYXNBdHRyaWJ1dGUiLCJoaWRlT25DdXJyZW50IiwiZGlzcGxheSIsImNsYXNzTGlzdCIsInJlbW92ZSIsImRpc2FibGVkIiwiYWN0aW9uIiwiYWN0aW9ucyIsImluY2x1ZGVzIiwicmlnaHRCdG4iLCJhZGQiLCJ2aXNpYmlsaXR5Iiwib3BhY2l0eSIsImEiLCJpZCIsInNlY3Rpb24iLCJnZXRFbGVtZW50QnlJZCIsIndhcm4iLCJBY3Rpb24iLCJ1bmxvY2tBdHRyaWJ1dGVOYW1lIiwibG9ja0F0dHJpYnV0ZU5hbWUiLCJ1bmxvY2tEYXRhIiwiTWFwIiwibG9ja0RhdGEiLCJfaW5pdExvY2tPclVubG9ja0FmdGVyVmlzaXRzIiwiX2NoZWNrU2VjdGlvbnMiLCJVTkxPQ0siLCJMT0NLIiwiYXR0cmlidXRlTmFtZSIsImRhdGEiLCJoYXMiLCJnZXQiLCJzZWN0aW9uVG9Mb2NrT3JVbmxvY2tJZCIsInNlY3Rpb25Ub0xvY2tPclVuTG9jayIsInNlY3Rpb25zVG9WaXNpdFJlbWFpbmluZyIsImZpbHRlciIsImpvaW4iLCJFcnJvciIsImhpZGUiLCJ1bmxvY2tTZWN0aW9ucyIsInNlY3Rpb25Ub1VubG9ja0lkIiwic2V0IiwiU2V0IiwicmVnaXN0ZXJQbHVnaW4iLCJFbGVtZW50IiwicHJvdG90eXBlIiwibmFtZSIsImZvcmNlIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBRUEsQ0FBQyxZQUFZO0FBRVQsTUFBTUEsTUFBTSxHQUFHO0FBQ1hDLElBQUFBLElBQUksRUFBRSxnQkFBTTtBQUNSLFVBQU1DLEtBQUssR0FBR0MsUUFBUSxDQUFDQyxhQUFULENBQXVCLE9BQXZCLENBQWQ7QUFD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a0JsRCxlQUFsQixHQUFvQyxVQUFVbUQsSUFBVixFQUFnQkMsS0FBaEIsRUFBdUI7QUFDdkQsVUFBSUEsS0FBSyxLQUFLLEtBQUssQ0FBbkIsRUFBc0JBLEtBQUssR0FBRyxDQUFDLENBQUNBLEtBQVY7O0FBRXRCLFVBQUksS0FBSy9DLFlBQUwsQ0FBa0I4QyxJQUFsQixDQUFKLEVBQTZCO0FBQ3pCLFlBQUlDLEtBQUosRUFBVyxPQUFPLElBQVA7QUFFWCxhQUFLbkQsZUFBTCxDQUFxQmtELElBQXJCO0FBQ0EsZUFBTyxLQUFQO0FBQ0g7O0FBQ0QsVUFBSUMsS0FBSyxLQUFLLEtBQWQsRUFBcUIsT0FBTyxLQUFQO0FBRXJCLFdBQUt0RCxZQUFMLENBQWtCcUQsSUFBbEIsRUFBd0IsRUFBeEI7QUFDQSxhQUFPLElBQVA7QUFDSCxLQWJEO0FBY0g7QUFHSixDQXpWRCIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGggPVwiLi4vLi4vbm9kZV9tb2R1bGVzL0B0eXBlcy9yZXZlYWwvaW5kZXguZC50c1wiLz5cblxuKGZ1bmN0aW9uICgpIHtcblxuICAgIGNvbnN0IHBsdWdpbiA9IHtcbiAgICAgICAgaW5pdDogKCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpO1xuICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7XG4gICAgICAgICAgICBSZXZlYWwuYWRkRXZlbnRMaXN0ZW5lcignc2xpZGVjaGFuZ2VkJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgIGFkZFN1cHBvcnRGb3JUaW1lZFNlY3Rpb25zKGV2ZW50KVxuICAgICAgICAgICAgICAgIGFkZFN1cHBvcnRGb3JPbmVUaW1lU2VjdGlvbnMoZXZlbnQpXG4gICAgICAgICAgICAgICAgYWRkU3VwcG9ydEZvclVuaGlkZVNlY3Rpb25zKGV2ZW50KVxuICAgICAgICAgICAgICAgIGFkZFN1cHBvcnRUb0hpZGVDb250cm9scyhldmVudClcbiAgICAgICAgICAgICAgICBhZGRTdXBwb3J0VG9IaWRlT3RoZXJTZWN0aW9ucyhldmVudClcbiAgICAgICAgICAgICAgICBhZGRTdXBwb3J0VG9VbkhpZGVPdGhlclNlY3Rpb25zKGV2ZW50KVxuICAgICAgICAgICAgICAgIGFkZFN1cHBvcnRUb0hpZGVBZnRlclZpc2l0KGV2ZW50KVxuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGFkZFN1cHBvcnRUb0xvY2tPclVubG9ja0FmdGVyVmlzaXRzKClcbiAgICAgICAgICAgIGFkZFN1cHBvcnRGb3JBbmNob3JXaXRoRGF0YUxpbmsoc3R5bGUuc2hlZXQgYXMgQ1NTU3R5bGVTaGVldCk7XG4gICAgICAgICAgICBhZGRTdXBwb3J0Rm9yUHJvY2VlZFRvTmV4dEFmdGVyVmlkZW9QbGF5ZWQoKVxuXG5cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBBdXRvbWF0aWMgcHJvY2VlZCB0byBuZXh0IHNsaWRlICBvbmNlIGEgdmlkZW8gaGFzIGNvbXBsZXRlZFxuICAgICAqL1xuXG4gICAgZnVuY3Rpb24gYWRkU3VwcG9ydEZvclByb2NlZWRUb05leHRBZnRlclZpZGVvUGxheWVkKCkge1xuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsPEhUTUxWaWRlb0VsZW1lbnQ+KFwidmlkZW9bZGF0YS1hdXRvLW5leHRdXCIpLmZvckVhY2godiA9PiB7XG4gICAgICAgICAgICB2LmFkZEV2ZW50TGlzdGVuZXIoJ2VuZGVkJywgXyA9PiBSZXZlYWwubmV4dCgpKVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGFsbG93cyBmb3JcbiAgICAgKiBgPGEgZGF0YS1saW5rLWluZGV4aD1cIjFcIj5saW5rIHRvIHNsaWRlPC9hPmBcbiAgICAgKiBAcGFyYW0gd2VieWFybnNDU1NcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0Rm9yQW5jaG9yV2l0aERhdGFMaW5rKHdlYnlhcm5zQ1NTOiBDU1NTdHlsZVNoZWV0KSB7XG4gICAgICAgIHdlYnlhcm5zQ1NTLmluc2VydFJ1bGUoXCJhW2RhdGEtbGluay1pbmRleGhdIHsgY3Vyc29yOiBwb2ludGVyIH1cIiwgMCk7XG4gICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJhW2RhdGEtbGluay1pbmRleGhdXCIpXG4gICAgICAgICAgICAuZm9yRWFjaChlID0+IGUuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIChldnQpID0+IHtcbiAgICAgICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBzID0gZS5nZXRBdHRyaWJ1dGUoXCJkYXRhLWxpbmstaW5kZXhoXCIpO1xuICAgICAgICAgICAgICAgIGlmIChzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHBhcnNlSW50KHMsIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnNsaWRlKGlkeClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pKVxuICAgIH1cblxuXG4gICAgZnVuY3Rpb24gaXNJbmRleCh2YWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAvXlxcZCskLy50ZXN0KHZhbHVlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIFN5bnRheFxuICAgICAqIDxzZWN0aW9uIGRhdGEtYXV0by1tb3ZlLXRvPVwiLi4uXCIgZGF0YS1hdXRvLW1vdmUtdGltZS1zZWM9XCIuLj5cbiAgICAgKlxuICAgICAqIEF1dG9tYXRpY2FsbHkgbW92ZXMgdG8gYSBzZWN0aW9uIGFmdGVyIGEgdGltZW91dFxuICAgICAqIFBvc3NpYmxlIHZhbHVlcyBmb3IgZGF0YS1hdXRvLW1vdmUtdG86XG4gICAgICogIC0gJ25leHQnIGFuZCAncHJldidcbiAgICAgKiAgLSBhIHVybCBoYXNoIHZhbHVlICgnIy9zb21lLWlkJylcbiAgICAgKiAgLSBpZCBvZiBhIHNlY3Rpb24gKCdzb21lLWlkJylcbiAgICAgKiAgLSBhbiBwb3NpdGlvbiAob25lLWJhc2VkKSBvZiBhIHNlY3Rpb24gKCcxMicpXG4gICAgICpcbiAgICAgKiAgZGF0YS1hdXRvLW1vdmUtdGltZS1zZWMgaXMgb3B0aW9uYWwuIERlZmF1bHRzIHRvIDEgc2Vjb25kXG4gICAgICovXG4gICAgZnVuY3Rpb24gYWRkU3VwcG9ydEZvclRpbWVkU2VjdGlvbnMoZXZlbnQ6IFNsaWRlRXZlbnQpIHtcblxuICAgICAgICBjb25zdCByeCA9IC9yYW5kb21cXCgoWzAtOSxcXHNdKylcXCkvO1xuICAgICAgICBjb25zdCBjdXJBdXRvTW92ZSA9IGV2ZW50LmN1cnJlbnRTbGlkZS5nZXRBdHRyaWJ1dGUoXCJkYXRhLWF1dG8tbW92ZS10b1wiKTtcbiAgICAgICAgaWYgKGN1ckF1dG9Nb3ZlKSB7XG4gICAgICAgICAgICBjb25zdCBwcm92aWRlZFZhbHVlID0gZXZlbnQuY3VycmVudFNsaWRlLmdldEF0dHJpYnV0ZShcImRhdGEtYXV0by1tb3ZlLXRpbWUtc2VjXCIpO1xuICAgICAgICAgICAgY29uc3QgdGltZW91dCA9IHByb3ZpZGVkVmFsdWUgPyBOdW1iZXIucGFyc2VGbG9hdChwcm92aWRlZFZhbHVlKSAqIDEwMDAgOiAxO1xuICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBjdXJBdXRvTW92ZS5tYXRjaChyeClcbiAgICAgICAgICAgIGNvbnN0IHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGN1ckF1dG9Nb3ZlID09PSBcIm5leHRcIikge1xuICAgICAgICAgICAgICAgICAgICBSZXZlYWwubmV4dCgpXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJBdXRvTW92ZSA9PT0gXCJwcmV2XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnByZXYoKVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VyQXV0b01vdmUuY2hhckF0KDApID09PSBcIiNcIikge1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gY3VyQXV0b01vdmU7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZXMgPSBtYXRjaFsxXS5zcGxpdChcIixcIikubWFwKGUgPT4gZS50cmltKCkpLm1hcChpID0+IE51bWJlci5wYXJzZUludChpLCAxMCkpXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhbmRvbSA9IHZhbHVlc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB2YWx1ZXMubGVuZ3RoKV1cbiAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnNsaWRlKHJhbmRvbSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5kZXgoY3VyQXV0b01vdmUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzbGlkZSA9IHBhcnNlSW50KGN1ckF1dG9Nb3ZlLCAxMCkgLSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgUmV2ZWFsLnNsaWRlKHNsaWRlKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGkgPSBXZWJ5YXJucy5sb29rdXBJbmRleChjdXJBdXRvTW92ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJnZXQgbm90IGZpbmQgc2xpZGUgd2l0aCBpZFwiLCBjdXJBdXRvTW92ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIFJldmVhbC5zbGlkZShpKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgdGltZW91dCk7XG4gICAgICAgICAgICBSZXZlYWwuYWRkRXZlbnRMaXN0ZW5lcignc2xpZGVjaGFuZ2VkJywgKCkgPT4gY2xlYXJUaW1lb3V0KHRpbWVyKSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIHN5bnRheCBkYXRhLW9uZS10aW1lXG4gICAgICpcbiAgICAgKiBTZWN0aW9uIGlzIHNob3duIG9ubHkgb25lIHRpbWVcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0Rm9yT25lVGltZVNlY3Rpb25zKGV2ZW50OiBTbGlkZUV2ZW50KSB7XG4gICAgICAgIGxldCBwcmV2U2xpZGUgPSBldmVudC5wcmV2aW91c1NsaWRlO1xuICAgICAgICBpZiAoIXByZXZTbGlkZSlcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICBjb25zdCBvbmV0aW1lID0gcHJldlNsaWRlLmdldEF0dHJpYnV0ZShcImRhdGEtb25lLXRpbWVcIik7XG4gICAgICAgIGlmIChvbmV0aW1lKVxuICAgICAgICAgICAgcHJldlNsaWRlLnNldEF0dHJpYnV0ZShcImRhdGEtaGlkZGVuLXNlY3Rpb25cIiwgXCJ0cnVlXCIpXG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBzeW50YXggPHNlY3Rpb24gZGF0YS11bmhpZGU9XCJ0b2dnbGUgfCBvbmNlXCItPlxuICAgICAqXG4gICAgICogU2VjdGlvbiBpcyBzaG93biBvbmx5IG9uZSB0aW1lXG4gICAgICovXG4gICAgZnVuY3Rpb24gYWRkU3VwcG9ydEZvclVuaGlkZVNlY3Rpb25zKGV2ZW50OiBTbGlkZUV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHVuaGlkZSA9IGV2ZW50LmN1cnJlbnRTbGlkZS5nZXRBdHRyaWJ1dGUoXCJkYXRhLXVuaGlkZVwiKVxuICAgICAgICBpZiAoIXVuaGlkZSlcbiAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgIHN3aXRjaCAodW5oaWRlKSB7XG4gICAgICAgICAgICBjYXNlIFwidG9nZ2xlXCI6XG4gICAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFNsaWRlLnRvZ2dsZUF0dHJpYnV0ZShcImRhdGEtaGlkZGVuLXNlY3Rpb25cIilcbiAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSBcIlwiOlxuICAgICAgICAgICAgY2FzZSBcIm9uY2VcIjpcbiAgICAgICAgICAgICAgICBldmVudC5jdXJyZW50U2xpZGUucmVtb3ZlQXR0cmlidXRlKFwiZGF0YS1oaWRkZW4tc2VjdGlvblwiKVxuICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYHdlYnlhcm4ncyBAZGF0YS11bmhpZGUgdW5rbm93biB2YWx1ZSAke3VuaGlkZX0sIG11c3QgYmUgb25lIG9mOiBcInRvZ2dsZVwiIHwgXCJvbmNlXCIgfCBcIlwiYCwpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBzeW50YXg6IGRhdGEtaGlkZS1jb250cm9sc1xuICAgICAqXG4gICAgICogaGlkZXMgY29udHJvbHMgb24gc2xpZGVcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0VG9IaWRlQ29udHJvbHMoZXZlbnQ6IFNsaWRlRXZlbnQpIHtcbiAgICAgICAgY29uc3QgY29udHJvbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yPEhUTUxFbGVtZW50PihcIi5jb250cm9sc1wiKVxuICAgICAgICBsZXQgaGlkZU9uUHJldiA9IGV2ZW50LnByZXZpb3VzU2xpZGU/Lmhhc0F0dHJpYnV0ZShcImRhdGEtaGlkZS1jb250cm9sc1wiKTtcbiAgICAgICAgbGV0IGhpZGVPbkN1cnJlbnQgPSBldmVudC5jdXJyZW50U2xpZGUuaGFzQXR0cmlidXRlKFwiZGF0YS1oaWRlLWNvbnRyb2xzXCIpO1xuXG4gICAgICAgIGlmIChjb250cm9scyAmJiBoaWRlT25QcmV2KSB7XG4gICAgICAgICAgICBjb250cm9scy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgICAgIGNvbnRyb2xzLnF1ZXJ5U2VsZWN0b3JBbGw8SFRNTEJ1dHRvbkVsZW1lbnQ+KFwiYnV0dG9uOm5vdCgubmF2aWdhdGUtbGVmdClcIikuZm9yRWFjaChlID0+IHtcbiAgICAgICAgICAgICAgICBlLnN0eWxlLmRpc3BsYXkgPSBgYmxvY2tgXG4gICAgICAgICAgICAgICAgZS5jbGFzc0xpc3QucmVtb3ZlKFwiaW1wYWlyXCIpXG4gICAgICAgICAgICAgICAgZS5kaXNhYmxlZCA9IGZhbHNlXG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICAgIGlmIChjb250cm9scyAmJiBoaWRlT25DdXJyZW50KSB7XG4gICAgICAgICAgICBsZXQgYWN0aW9uID0gZXZlbnQuY3VycmVudFNsaWRlLmdldEF0dHJpYnV0ZShcImRhdGEtaGlkZS1jb250cm9sc1wiKTtcbiAgICAgICAgICAgIGlmICghYWN0aW9uIHx8IGFjdGlvbiA9PT0gXCJcIikge1xuICAgICAgICAgICAgICAgIGNvbnRyb2xzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGFjdGlvbnMgPSBhY3Rpb24hLnNwbGl0KChcIixcIikpLm1hcChzID0+IHMudHJpbSgpKVxuICAgICAgICAgICAgICAgIGlmIChhY3Rpb25zLmluY2x1ZGVzKFwia2VlcC1sZWZ0XCIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzLnF1ZXJ5U2VsZWN0b3JBbGw8SFRNTEJ1dHRvbkVsZW1lbnQ+KFwiYnV0dG9uOm5vdCgubmF2aWdhdGUtbGVmdClcIikuZm9yRWFjaChlID0+IGUuc3R5bGUuZGlzcGxheSA9IGBub25lYClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbnMuaW5jbHVkZXMoXCJpbXBhaXItcmlnaHRcIikpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmlnaHRCdG4gPSBjb250cm9scy5xdWVyeVNlbGVjdG9yPEhUTUxCdXR0b25FbGVtZW50PihcIi5uYXZpZ2F0ZS1yaWdodFwiKSFcblxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0QnRuLmNsYXNzTGlzdC5yZW1vdmUoXCJlbmFibGVkXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEJ0bi5jbGFzc0xpc3QuYWRkKFwiaW1wYWlyXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEJ0bi5zdHlsZS5kaXNwbGF5ID0gYGJsb2NrYFxuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRCdG4uc3R5bGUudmlzaWJpbGl0eSA9IGB2aXNpYmxlYFxuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRCdG4uc3R5bGUub3BhY2l0eSA9IFwiMVwiXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodEJ0bi5kaXNhYmxlZCA9IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSwgMClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogIHN5bnRheCBkYXRhLWhpZGUtc2VjdGlvbj1cIsKraWTCuyzCq2lkwrtcIlxuICAgICAqIEBwYXJhbSBldmVudFxuICAgICAqL1xuICAgIGZ1bmN0aW9uIGFkZFN1cHBvcnRUb0hpZGVPdGhlclNlY3Rpb25zKGV2ZW50OiBTbGlkZUV2ZW50KSB7XG4gICAgICAgIGNvbnN0IGEgPSBldmVudC5jdXJyZW50U2xpZGUuZ2V0QXR0cmlidXRlKFwiZGF0YS1oaWRlLXNlY3Rpb25cIik7XG4gICAgICAgIGlmICghYSlcbiAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgIGEuc3BsaXQoXCIsXCIpLmZvckVhY2goaWQgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2VjdGlvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTtcbiAgICAgICAgICAgIGlmICghc2VjdGlvbilcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYGNhbm5vdCBmaW5kIGVsZW1lbnQgd2l0aCBpZCAke2lkfSB0byBoaWRlYClcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBzZWN0aW9uLnNldEF0dHJpYnV0ZShcImRhdGEtaGlkZGVuLXNlY3Rpb25cIiwgXCJcIilcbiAgICAgICAgfSlcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqICBzeW50YXggZGF0YS11bmhpZGUtc2VjdGlvbj1cIsKraWTCuyzCq2lkwrtcIlxuICAgICAqIEBwYXJhbSBldmVudFxuICAgICAqL1xuICAgIGZ1bmN0aW9uIGFkZFN1cHBvcnRUb1VuSGlkZU90aGVyU2VjdGlvbnMoZXZlbnQ6IFNsaWRlRXZlbnQpIHtcbiAgICAgICAgY29uc3QgYSA9IGV2ZW50LmN1cnJlbnRTbGlkZS5nZXRBdHRyaWJ1dGUoXCJkYXRhLXVuaGlkZS1zZWN0aW9uXCIpO1xuICAgICAgICBpZiAoIWEpXG4gICAgICAgICAgICByZXR1cm5cblxuICAgICAgICBhLnNwbGl0KFwiLFwiKS5mb3JFYWNoKGlkID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNlY3Rpb24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7XG4gICAgICAgICAgICBpZiAoIXNlY3Rpb24pXG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBjYW5ub3QgZmluZCBlbGVtZW50IHdpdGggaWQgJHtpZH0gdG8gaGlkZWApXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgc2VjdGlvbi5yZW1vdmVBdHRyaWJ1dGUoXCJkYXRhLWhpZGRlbi1zZWN0aW9uXCIpXG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBkYXRhLWhpZGUtYWZ0ZXItdmlzaXRcbiAgICAgKi9cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0VG9IaWRlQWZ0ZXJWaXNpdChldmVudDogU2xpZGVFdmVudCkge1xuICAgICAgICBpZiAoZXZlbnQuY3VycmVudFNsaWRlLmhhc0F0dHJpYnV0ZShcImRhdGEtaGlkZS1hZnRlci12aXNpdFwiKSkge1xuICAgICAgICAgICAgZXZlbnQuY3VycmVudFNsaWRlLnNldEF0dHJpYnV0ZShcImRhdGEtaGlkZGVuLXNlY3Rpb25cIiwgXCJcIilcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGVudW0gQWN0aW9uIHtcbiAgICAgICAgTE9DSywgVU5MT0NLXG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBkYXRhLXVubG9jay1hZnRlci12aXNpdGVkPVwiYSxiXCJcbiAgICAgKi9cbiAgICBjb25zdCB1bmxvY2tBdHRyaWJ1dGVOYW1lID0gXCJkYXRhLXVubG9jay1hZnRlci12aXNpdGVkXCI7XG4gICAgY29uc3QgbG9ja0F0dHJpYnV0ZU5hbWUgPSBcImRhdGEtbG9jay1hZnRlci12aXNpdGVkXCI7XG5cbiAgICBmdW5jdGlvbiBhZGRTdXBwb3J0VG9Mb2NrT3JVbmxvY2tBZnRlclZpc2l0cygpIHtcbiAgICAgICAgY29uc3QgdW5sb2NrRGF0YSA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKVxuICAgICAgICBjb25zdCBsb2NrRGF0YSA9IG5ldyBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4oKVxuICAgICAgICBfaW5pdExvY2tPclVubG9ja0FmdGVyVmlzaXRzKHVubG9ja0F0dHJpYnV0ZU5hbWUsIHVubG9ja0RhdGEsIHRydWUpO1xuICAgICAgICBfaW5pdExvY2tPclVubG9ja0FmdGVyVmlzaXRzKGxvY2tBdHRyaWJ1dGVOYW1lLCBsb2NrRGF0YSwgZmFsc2UpO1xuICAgICAgICBSZXZlYWwuYWRkRXZlbnRMaXN0ZW5lcignc2xpZGVjaGFuZ2VkJywgKGV2ZW50OiBTbGlkZUV2ZW50KSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGlkID0gZXZlbnQuY3VycmVudFNsaWRlLmdldEF0dHJpYnV0ZShcImlkXCIpXG4gICAgICAgICAgICBpZiAoaWQpIHtcbiAgICAgICAgICAgICAgICBfY2hlY2tTZWN0aW9ucyhpZCwgdW5sb2NrQXR0cmlidXRlTmFtZSwgdW5sb2NrRGF0YSwgQWN0aW9uLlVOTE9DSylcbiAgICAgICAgICAgICAgICBfY2hlY2tTZWN0aW9ucyhpZCwgbG9ja0F0dHJpYnV0ZU5hbWUsIGxvY2tEYXRhLCBBY3Rpb24uTE9DSylcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBfY2hlY2tTZWN0aW9ucyhpZDogc3RyaW5nLCAgYXR0cmlidXRlTmFtZTogc3RyaW5nLCBkYXRhOiBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4sIGFjdGlvbjogQWN0aW9uKSB7XG4gICAgICAgIGlmIChkYXRhLmhhcyhpZCkpIHtcblxuICAgICAgICAgICAgZGF0YS5nZXQoaWQpIS5mb3JFYWNoKHNlY3Rpb25Ub0xvY2tPclVubG9ja0lkID0+IHtcblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlY3Rpb25Ub0xvY2tPclVuTG9jayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlY3Rpb25Ub0xvY2tPclVubG9ja0lkKSE7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlY3Rpb25zVG9WaXNpdFJlbWFpbmluZyA9IHNlY3Rpb25Ub0xvY2tPclVuTG9ja1xuICAgICAgICAgICAgICAgICAgICAgICAgLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKSFcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zcGxpdCgoXCImXCIpKS5tYXAocyA9PiBzLnRyaW0oKSkuZmlsdGVyKHMgPT4gcyAhPSBpZClcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc2VjdGlvbnNUb1Zpc2l0UmVtYWluaW5nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvblRvTG9ja09yVW5Mb2NrLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbiA9PSBBY3Rpb24uVU5MT0NLKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY3Rpb25Ub0xvY2tPclVuTG9jay5yZW1vdmVBdHRyaWJ1dGUoXCJkYXRhLWhpZGRlbi1zZWN0aW9uXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvblRvTG9ja09yVW5Mb2NrLnNldEF0dHJpYnV0ZShcImRhdGEtaGlkZGVuLXNlY3Rpb25cIiwgXCJcIilcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWN0aW9uVG9Mb2NrT3JVbkxvY2suc2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUsIHNlY3Rpb25zVG9WaXNpdFJlbWFpbmluZy5qb2luKFwiJlwiKSlcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKGBlcnJvciBwcm9jZXNzaW5nICR7c2VjdGlvblRvTG9ja09yVW5sb2NrSWR9OiAke2V9YClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgZGF0YS5kZWxldGUoaWQpXG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gX2luaXRMb2NrT3JVbmxvY2tBZnRlclZpc2l0cyhhdHRyaWJ1dGVOYW1lOiBzdHJpbmcsIGRhdGE6IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PiwgaGlkZTogQm9vbGVhbikge1xuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGBzZWN0aW9uWyR7YXR0cmlidXRlTmFtZX1dYClcbiAgICAgICAgICAgIC5mb3JFYWNoKGUgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHVubG9ja1NlY3Rpb25zID0gZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkhLnNwbGl0KFwiJlwiKS5tYXAocyA9PiBzLnRyaW0oKSlcbiAgICAgICAgICAgICAgICB1bmxvY2tTZWN0aW9ucy5mb3JFYWNoKGlkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VjdGlvblRvVW5sb2NrSWQgPSBlLmdldEF0dHJpYnV0ZShcImlkXCIpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXNlY3Rpb25Ub1VubG9ja0lkKVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgc2VjdGlvbiB3aXRoIFske2F0dHJpYnV0ZU5hbWV9XSByZXF1aXJlcyBhbiBpZGApXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2V0ID0gZGF0YS5nZXQoaWQpID8/IG5ldyBTZXQoKVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXQuYWRkKHNlY3Rpb25Ub1VubG9ja0lkKVxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5zZXQoaWQsIHNldClcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgaWYgKGhpZGUpXG4gICAgICAgICAgICAgICAgICAgIGUuc2V0QXR0cmlidXRlKFwiZGF0YS1oaWRkZW4tc2VjdGlvblwiLCBcIlwiKVxuICAgICAgICAgICAgfSlcblxuXG4gICAgfVxuXG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgUmV2ZWFsLnJlZ2lzdGVyUGx1Z2luKCdXZWJ5YXJuUGx1Z2luJywgcGx1Z2luKTtcblxuICAgIC8vIFBvbHlmaWxsc1xuICAgIGlmICghRWxlbWVudC5wcm90b3R5cGUudG9nZ2xlQXR0cmlidXRlKSB7XG4gICAgICAgIEVsZW1lbnQucHJvdG90eXBlLnRvZ2dsZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChuYW1lLCBmb3JjZSkge1xuICAgICAgICAgICAgaWYgKGZvcmNlICE9PSB2b2lkIDApIGZvcmNlID0gISFmb3JjZVxuXG4gICAgICAgICAgICBpZiAodGhpcy5oYXNBdHRyaWJ1dGUobmFtZSkpIHtcbiAgICAgICAgICAgICAgICBpZiAoZm9yY2UpIHJldHVybiB0cnVlO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGZvcmNlID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShuYW1lLCBcIlwiKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgIH1cblxuXG59KVxuKClcbiJdfQ==